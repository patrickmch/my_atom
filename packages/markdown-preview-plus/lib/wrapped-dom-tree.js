"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const two_dim_array_1 = require("./two-dim-array");
let curHash = 0;
const hashTo = {};
class WrappedDomTree {
    constructor(dom, clone, rep) {
        this.children = [];
        this.size = 0;
        if (clone) {
            this.shownTree = new WrappedDomTree(dom, false, this);
            this.dom = dom.cloneNode(true);
        }
        else {
            this.dom = dom;
            this.rep = rep;
        }
        this.clone = clone;
        this.hash = curHash++;
        hashTo[this.hash] = this;
        this.isText = dom.nodeType === 3;
        this.tagName = dom.tagName;
        this.className = dom.className;
        this.textData = dom.data;
        this.diffHash = {};
        if (this.isText) {
            this.size = 1;
        }
        else {
            this.children = Array.from(this.dom.childNodes).map((dom, ind) => new WrappedDomTree(dom, false, rep ? rep.children[ind] : undefined));
            this.size = this.children.length
                ? this.children.reduce((prev, cur) => prev + cur.size, 0)
                : 0;
            if (!this.size) {
                this.size = 1;
            }
        }
    }
    diffTo(otherTree) {
        if (this.clone && this.shownTree) {
            return this.shownTree.diffTo(otherTree);
        }
        const diff = this.rep && this.rep.diff(otherTree);
        const operations = diff && diff.operations;
        let indexShift = 0;
        let inserted = [];
        let last;
        let possibleReplace;
        let r;
        let lastOp;
        let lastElmDeleted;
        let lastElmInserted;
        if (operations) {
            if (Array.isArray(operations)) {
                for (const op of operations) {
                    if (op.type === 'd') {
                        const possibleLastDeleted = this.children[op.tree + indexShift].dom;
                        r = this.remove(op.tree + indexShift);
                        this.rep && this.rep.remove(op.tree + indexShift);
                        if (!last || last.nextSibling === r || last === r) {
                            last = r;
                            if (last &&
                                lastOp &&
                                lastOp.type === 'i' &&
                                op.tree === lastOp.pos) {
                                lastElmDeleted = possibleLastDeleted;
                            }
                            else {
                                lastElmDeleted = undefined;
                                lastElmInserted = undefined;
                            }
                            lastOp = op;
                        }
                        indexShift--;
                    }
                    else if (op.type === 'i') {
                        this.rep &&
                            this.rep.insert(op.pos + indexShift, otherTree.children[op.otherTree]);
                        r = this.insert(op.pos + indexShift, otherTree.children[op.otherTree], this.rep && this.rep.children[op.pos + indexShift]);
                        inserted.push(r);
                        if (!last || last.nextSibling === r) {
                            last = r;
                            lastOp = op;
                            lastElmInserted = r;
                        }
                        indexShift++;
                    }
                    else {
                        const re = this.children[op.tree + indexShift].diffTo(otherTree.children[op.otherTree]);
                        if (!last ||
                            (last.nextSibling === this.children[op.tree + indexShift].dom &&
                                re.last)) {
                            ;
                            ({ last } = re);
                            if (re.possibleReplace) {
                                lastElmInserted = re.possibleReplace.cur;
                                lastElmDeleted = re.possibleReplace.prev;
                            }
                            lastOp = op;
                        }
                        inserted = inserted.concat(re.inserted);
                    }
                }
            }
            else {
                console.debug(operations);
                throw new Error('invalid operations');
            }
        }
        if (lastOp && lastOp.type !== 'i' && lastElmInserted && lastElmDeleted) {
            possibleReplace = {
                cur: lastElmInserted,
                prev: lastElmDeleted,
            };
        }
        return {
            last,
            inserted,
            possibleReplace,
        };
    }
    insert(i, tree, rep) {
        const dom = tree.dom.cloneNode(true);
        if (i === this.dom.childNodes.length) {
            this.dom.appendChild(dom);
        }
        else {
            this.dom.insertBefore(dom, this.dom.childNodes[i]);
        }
        const ctree = new WrappedDomTree(dom, false, rep);
        this.children.splice(i, 0, ctree);
        return this.dom.childNodes[i];
    }
    remove(i) {
        this.dom.removeChild(this.dom.childNodes[i]);
        this.children[i].removeSelf();
        this.children.splice(i, 1);
        return this.dom.childNodes[i - 1];
    }
    diff(otherTree, tmax) {
        let i;
        if (this.equalTo(otherTree)) {
            return { score: 0, operations: undefined };
        }
        if (this.cannotReplaceWith(otherTree)) {
            return { score: 1 / 0, operations: undefined };
        }
        const key = otherTree.hash;
        if (Object.keys(this.diffHash).includes(key.toString())) {
            return this.diffHash[key];
        }
        if (tmax === undefined) {
            tmax = 100000;
        }
        if (tmax <= 0) {
            return { score: 0 };
        }
        let offset = 0;
        const forwardSearch = (offset) => offset < this.children.length &&
            offset < otherTree.children.length &&
            this.children[offset].equalTo(otherTree.children[offset]);
        while (forwardSearch(offset)) {
            offset++;
        }
        const dp = new two_dim_array_1.TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        const p = new two_dim_array_1.TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        dp.set(0, 0, 0);
        let sum = 0;
        if (otherTree.children.length - offset > 1) {
            let asc;
            let end;
            for (i = 1, end = otherTree.children.length - offset - 1, asc = 1 <= end; asc ? i <= end : i >= end; asc ? i++ : i--) {
                dp.set(0, i, sum);
                p.set(0, i, i - 1);
                sum += otherTree.children[i + offset].size;
            }
        }
        if (otherTree.children.length - offset > 0) {
            dp.set(0, otherTree.children.length - offset, sum);
            p.set(0, otherTree.children.length - offset, otherTree.children.length - 1 - offset);
        }
        sum = 0;
        if (this.children.length - offset > 1) {
            let asc1;
            let end1;
            for (i = 1, end1 = this.children.length - offset - 1, asc1 = 1 <= end1; asc1 ? i <= end1 : i >= end1; asc1 ? i++ : i--) {
                dp.set(i, 0, sum);
                p.set(i, 0, (i - 1) * p.col);
                sum += this.children[i + offset].size;
            }
        }
        if (this.children.length - offset) {
            dp.set(this.children.length - offset, 0, sum);
            p.set(this.children.length - offset, 0, (this.children.length - 1 - offset) * p.col);
        }
        const getScore = (i, j, max) => {
            const res = dp.get(i, j);
            if (res !== undefined) {
                return res;
            }
            if (max === undefined) {
                max = 1 / 0;
            }
            if (max <= 0) {
                return 1 / 0;
            }
            let val = max;
            const bound = max;
            const subdiff = this.children[i - 1 + offset].diff(otherTree.children[j - 1 + offset], bound).score;
            let force = false;
            if (subdiff < bound &&
                subdiff + 1 <
                    this.children[i - 1 + offset].size +
                        otherTree.children[j - 1 + offset].size) {
                force = true;
            }
            val = getScore(i - 1, j - 1, bound - subdiff) + subdiff;
            let prev = p.getInd(i - 1, j - 1);
            if (!force) {
                let other = getScore(i - 1, j, Math.min(val, max) - this.children[i - 1 + offset].size) + this.children[i - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i - 1, j);
                    val = other;
                }
                other =
                    getScore(i, j - 1, Math.min(val, max) - otherTree.children[j - 1 + offset].size) + otherTree.children[j - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i, j - 1);
                    val = other;
                }
            }
            if (val >= max) {
                val = 1 / 0;
            }
            dp.set(i, j, val);
            p.set(i, j, prev);
            return val;
        };
        const score = getScore(this.children.length - offset, otherTree.children.length - offset, tmax);
        const operations = [];
        let cur = p.getInd(this.children.length - offset, otherTree.children.length - offset);
        let cr = this.children.length - 1 - offset;
        let cc = otherTree.children.length - 1 - offset;
        while (p.rawGet(cur) !== undefined) {
            const prev = p.rawGet(cur);
            const rc = p.get2DInd(prev);
            const pr = rc.r - 1;
            const pc = rc.c - 1;
            if (pr === cr) {
                operations.unshift({
                    type: 'i',
                    otherTree: cc + offset,
                    pos: cr + 1 + offset,
                });
            }
            else if (pc === cc) {
                operations.unshift({
                    type: 'd',
                    tree: cr + offset,
                });
            }
            else {
                const op = this.children[cr + offset].diff(otherTree.children[cc + offset]).operations;
                if (op && op.length) {
                    operations.unshift({
                        type: 'r',
                        tree: cr + offset,
                        otherTree: cc + offset,
                    });
                }
            }
            cur = prev;
            cr = pr;
            cc = pc;
        }
        this.diffHash[key] = {
            score,
            operations,
        };
        return this.diffHash[key];
    }
    equalTo(otherTree) {
        return this.dom.isEqualNode(otherTree.dom);
    }
    cannotReplaceWith(otherTree) {
        return (this.isText ||
            otherTree.isText ||
            this.tagName !== otherTree.tagName ||
            this.className !== otherTree.className ||
            this.className === 'math' ||
            this.className === 'atom-text-editor' ||
            this.tagName === 'A' ||
            (this.tagName === 'IMG' && !this.dom.isEqualNode(otherTree.dom)));
    }
    getContent() {
        if (this.dom.outerHTML) {
            return this.dom.outerHTML;
        }
        else {
            return this.textData;
        }
    }
    removeSelf() {
        hashTo[this.hash] = undefined;
        this.children &&
            this.children.forEach((c) => {
                c.removeSelf();
            });
    }
}
exports.WrappedDomTree = WrappedDomTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JhcHBlZC1kb20tdHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy93cmFwcGVkLWRvbS10cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBc0JBLG1EQUE2QztBQUU3QyxJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUE7QUFDZixNQUFNLE1BQU0sR0FBa0QsRUFBRSxDQUFBO0FBT2hFO0lBeUJFLFlBQVksR0FBWSxFQUFFLEtBQWMsRUFBRSxHQUFvQjtRQXJCdEQsYUFBUSxHQUFxQixFQUFFLENBQUE7UUFDL0IsU0FBSSxHQUFXLENBQUMsQ0FBQTtRQXFCdEIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUNyRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFZLENBQUE7UUFDM0MsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUE7WUFDZCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQTtRQUNoQixDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxPQUFPLEVBQUUsQ0FBQTtRQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQTtRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxRQUFRLEtBQUssQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQTtRQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUE7UUFDOUIsSUFBSSxDQUFDLFFBQVEsR0FBSSxHQUFrQyxDQUFDLElB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QyxDQUFDO1lBQ04sTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUE7UUFDdEIsQ0FBQztJQUNILENBQUM7SUFFRCxVQUFVO1FBQ1IsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUE7UUFDN0IsSUFBSSxDQUFDLFFBQVE7WUFDWCxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO2dCQUMxQixDQUFDLENBQUMsVUFBVSxFQUFFLENBQUE7WUFDaEIsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0NBQ0Y7QUF6YkQsd0NBeWJDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVGhpcyBmaWxlIGluY29ycG9yYXRlcyBjb2RlIGZyb20gW21hcmttb25dKGh0dHBzOi8vZ2l0aHViLmNvbS95eWpoYW8vbWFya21vbilcbi8vIGNvdmVyZWQgYnkgdGhlIGZvbGxvd2luZyB0ZXJtczpcbi8vXG4vLyBDb3B5cmlnaHQgKGMpIDIwMTQsIFlhbyBZdWppYW4sIGh0dHA6Ly95anlhby5jb21cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuaW1wb3J0IHsgVHdvRGltQXJyYXkgfSBmcm9tICcuL3R3by1kaW0tYXJyYXknXG5cbmxldCBjdXJIYXNoID0gMFxuY29uc3QgaGFzaFRvOiB7IFtrZXk6IHN0cmluZ106IFdyYXBwZWREb21UcmVlIHwgdW5kZWZpbmVkIH0gPSB7fVxuXG50eXBlIE9wZXJhdGlvbiA9XG4gIHwgeyB0eXBlOiAncic7IHRyZWU6IG51bWJlcjsgb3RoZXJUcmVlOiBudW1iZXIgfVxuICB8IHsgdHlwZTogJ2QnOyB0cmVlOiBudW1iZXIgfVxuICB8IHsgdHlwZTogJ2knOyBvdGhlclRyZWU6IG51bWJlcjsgcG9zOiBudW1iZXIgfVxuXG5leHBvcnQgY2xhc3MgV3JhcHBlZERvbVRyZWUge1xuICBwdWJsaWMgcmVhZG9ubHkgc2hvd25UcmVlPzogV3JhcHBlZERvbVRyZWVcbiAgcHVibGljIHJlYWRvbmx5IGRvbTogRWxlbWVudFxuICBwcml2YXRlIHRleHREYXRhOiBzdHJpbmdcbiAgcHJpdmF0ZSBjaGlsZHJlbjogV3JhcHBlZERvbVRyZWVbXSA9IFtdXG4gIHByaXZhdGUgc2l6ZTogbnVtYmVyID0gMFxuICBwcml2YXRlIGRpZmZIYXNoOiB7XG4gICAgW2tleTogc3RyaW5nXToge1xuICAgICAgc2NvcmU6IG51bWJlclxuICAgICAgb3BlcmF0aW9ucz86IE9wZXJhdGlvbltdXG4gICAgfVxuICB9XG4gIHByaXZhdGUgY2xhc3NOYW1lOiBzdHJpbmdcbiAgcHJpdmF0ZSB0YWdOYW1lOiBzdHJpbmdcbiAgcHJpdmF0ZSByZXA/OiBXcmFwcGVkRG9tVHJlZVxuICBwcml2YXRlIGlzVGV4dDogYm9vbGVhblxuICBwcml2YXRlIGhhc2g6IG51bWJlclxuICBwcml2YXRlIGNsb25lOiBib29sZWFuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bmluaXRpYWxpemVkXG4gIC8vIEBwYXJhbSBkb20gQSBET00gZWxlbWVudCBvYmplY3RcbiAgLy8gICAgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL2VsZW1lbnRcbiAgLy8gQHBhcmFtIGNsb25lIEJvb2xlYW4gZmxhZyBpbmRpY2F0aW5nIGlmIHRoaXMgaXMgdGhlIERPTSB0cmVlIHRvIG1vZGlmeVxuICAvLyBAcGFyYW0gcmVwIFdyYXBwZWREb21UcmVlIG9mIGEgRE9NIGVsZW1lbnQgbm9kZSBpbiBkb21cbiAgY29uc3RydWN0b3IoZG9tOiBFbGVtZW50LCBjbG9uZTogdHJ1ZSlcbiAgY29uc3RydWN0b3IoZG9tOiBFbGVtZW50LCBjbG9uZTogZmFsc2UsIHJlcD86IFdyYXBwZWREb21UcmVlKVxuICBjb25zdHJ1Y3Rvcihkb206IEVsZW1lbnQsIGNsb25lOiBib29sZWFuLCByZXA/OiBXcmFwcGVkRG9tVHJlZSkge1xuICAgIGlmIChjbG9uZSkge1xuICAgICAgdGhpcy5zaG93blRyZWUgPSBuZXcgV3JhcHBlZERvbVRyZWUoZG9tLCBmYWxzZSwgdGhpcylcbiAgICAgIHRoaXMuZG9tID0gZG9tLmNsb25lTm9kZSh0cnVlKSBhcyBFbGVtZW50XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZG9tID0gZG9tXG4gICAgICB0aGlzLnJlcCA9IHJlcFxuICAgIH1cblxuICAgIHRoaXMuY2xvbmUgPSBjbG9uZVxuICAgIHRoaXMuaGFzaCA9IGN1ckhhc2grK1xuICAgIGhhc2hUb1t0aGlzLmhhc2hdID0gdGhpc1xuICAgIHRoaXMuaXNUZXh0ID0gZG9tLm5vZGVUeXBlID09PSAzXG4gICAgdGhpcy50YWdOYW1lID0gZG9tLnRhZ05hbWVcbiAgICB0aGlzLmNsYXNzTmFtZSA9IGRvbS5jbGFzc05hbWVcbiAgICB0aGlzLnRleHREYXRhID0gKGRvbSBhcyBFbGVtZW50ICYgeyBkYXRhOiBzdHJpbmcgfSkuZGF0YVxuICAgIHRoaXMuZGlmZkhhc2ggPSB7fVxuXG4gICAgaWYgKHRoaXMuaXNUZXh0KSB7XG4gICAgICB0aGlzLnNpemUgPSAxXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2hpbGRyZW4gPSBBcnJheS5mcm9tKHRoaXMuZG9tLmNoaWxkTm9kZXMpLm1hcChcbiAgICAgICAgKGRvbSwgaW5kKSA9PlxuICAgICAgICAgIG5ldyBXcmFwcGVkRG9tVHJlZShcbiAgICAgICAgICAgIGRvbSBhcyBFbGVtZW50LFxuICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICByZXAgPyByZXAuY2hpbGRyZW5baW5kXSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICApLFxuICAgICAgKVxuICAgICAgdGhpcy5zaXplID0gdGhpcy5jaGlsZHJlbi5sZW5ndGhcbiAgICAgICAgPyB0aGlzLmNoaWxkcmVuLnJlZHVjZSgocHJldiwgY3VyKSA9PiBwcmV2ICsgY3VyLnNpemUsIDApXG4gICAgICAgIDogMFxuICAgICAgaWYgKCF0aGlzLnNpemUpIHtcbiAgICAgICAgdGhpcy5zaXplID0gMVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIEBwYXJhbSBvdGhlclRyZWUgV3JhcHBlZERvbVRyZWUgb2YgYSBET00gZWxlbWVudCB0byBkaWZmIGFnYWluc3RcbiAgcHVibGljIGRpZmZUbyhcbiAgICBvdGhlclRyZWU6IFdyYXBwZWREb21UcmVlLFxuICApOiB7XG4gICAgcG9zc2libGVSZXBsYWNlPzoge1xuICAgICAgY3VyPzogTm9kZVxuICAgICAgcHJldj86IEVsZW1lbnRcbiAgICB9XG4gICAgaW5zZXJ0ZWQ6IE5vZGVbXVxuICAgIGxhc3Q/OiBOb2RlXG4gIH0ge1xuICAgIGlmICh0aGlzLmNsb25lICYmIHRoaXMuc2hvd25UcmVlKSB7XG4gICAgICByZXR1cm4gdGhpcy5zaG93blRyZWUuZGlmZlRvKG90aGVyVHJlZSlcbiAgICB9XG5cbiAgICBjb25zdCBkaWZmID0gdGhpcy5yZXAgJiYgdGhpcy5yZXAuZGlmZihvdGhlclRyZWUpXG4gICAgY29uc3Qgb3BlcmF0aW9ucyA9IGRpZmYgJiYgZGlmZi5vcGVyYXRpb25zXG4gICAgbGV0IGluZGV4U2hpZnQgPSAwXG4gICAgbGV0IGluc2VydGVkOiBOb2RlW10gPSBbXVxuXG4gICAgLy8gRm9yY2UgdmFyaWFibGVzIHRvIGxlYWsgdG8gZGlmZlRvIHNjb3BlXG4gICAgbGV0IGxhc3Q6IE5vZGUgfCB1bmRlZmluZWRcbiAgICBsZXQgcG9zc2libGVSZXBsYWNlXG4gICAgbGV0IHJcbiAgICBsZXQgbGFzdE9wOiBPcGVyYXRpb24gfCB1bmRlZmluZWRcbiAgICBsZXQgbGFzdEVsbURlbGV0ZWQ6IEVsZW1lbnQgfCB1bmRlZmluZWRcbiAgICBsZXQgbGFzdEVsbUluc2VydGVkOiBFbGVtZW50IHwgdW5kZWZpbmVkXG5cbiAgICBpZiAob3BlcmF0aW9ucykge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkob3BlcmF0aW9ucykpIHtcbiAgICAgICAgZm9yIChjb25zdCBvcCBvZiBvcGVyYXRpb25zKSB7XG4gICAgICAgICAgaWYgKG9wLnR5cGUgPT09ICdkJykge1xuICAgICAgICAgICAgY29uc3QgcG9zc2libGVMYXN0RGVsZXRlZCA9IHRoaXMuY2hpbGRyZW5bb3AudHJlZSArIGluZGV4U2hpZnRdLmRvbVxuICAgICAgICAgICAgciA9IHRoaXMucmVtb3ZlKG9wLnRyZWUgKyBpbmRleFNoaWZ0KVxuICAgICAgICAgICAgdGhpcy5yZXAgJiYgdGhpcy5yZXAucmVtb3ZlKG9wLnRyZWUgKyBpbmRleFNoaWZ0KVxuICAgICAgICAgICAgaWYgKCFsYXN0IHx8IGxhc3QubmV4dFNpYmxpbmcgPT09IHIgfHwgbGFzdCA9PT0gcikge1xuICAgICAgICAgICAgICBsYXN0ID0gclxuICAgICAgICAgICAgICAvLyBVbmRlZmluZWQgZXJyb3JzIGNhbiBiZSB0aHJvdyBzbyB3ZSBhZGQgYSBjb25kaXRpb24gb24gbGFzdE9wXG4gICAgICAgICAgICAgIC8vIGJlaW5nIGRlZmluZWRcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGxhc3QgJiZcbiAgICAgICAgICAgICAgICBsYXN0T3AgJiZcbiAgICAgICAgICAgICAgICBsYXN0T3AudHlwZSA9PT0gJ2knICYmXG4gICAgICAgICAgICAgICAgb3AudHJlZSA9PT0gbGFzdE9wLnBvc1xuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBsYXN0RWxtRGVsZXRlZCA9IHBvc3NpYmxlTGFzdERlbGV0ZWRcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsYXN0RWxtRGVsZXRlZCA9IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgIGxhc3RFbG1JbnNlcnRlZCA9IHVuZGVmaW5lZFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGxhc3RPcCA9IG9wXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpbmRleFNoaWZ0LS1cbiAgICAgICAgICB9IGVsc2UgaWYgKG9wLnR5cGUgPT09ICdpJykge1xuICAgICAgICAgICAgdGhpcy5yZXAgJiZcbiAgICAgICAgICAgICAgdGhpcy5yZXAuaW5zZXJ0KFxuICAgICAgICAgICAgICAgIG9wLnBvcyArIGluZGV4U2hpZnQsXG4gICAgICAgICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW29wLm90aGVyVHJlZV0sXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIHIgPSB0aGlzLmluc2VydChcbiAgICAgICAgICAgICAgb3AucG9zICsgaW5kZXhTaGlmdCxcbiAgICAgICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW29wLm90aGVyVHJlZV0sXG4gICAgICAgICAgICAgIHRoaXMucmVwICYmIHRoaXMucmVwLmNoaWxkcmVuW29wLnBvcyArIGluZGV4U2hpZnRdLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChyKVxuICAgICAgICAgICAgaWYgKCFsYXN0IHx8IGxhc3QubmV4dFNpYmxpbmcgPT09IHIpIHtcbiAgICAgICAgICAgICAgbGFzdCA9IHJcbiAgICAgICAgICAgICAgbGFzdE9wID0gb3BcbiAgICAgICAgICAgICAgbGFzdEVsbUluc2VydGVkID0gciBhcyBFbGVtZW50XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpbmRleFNoaWZ0KytcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgcmUgPSB0aGlzLmNoaWxkcmVuW29wLnRyZWUgKyBpbmRleFNoaWZ0XS5kaWZmVG8oXG4gICAgICAgICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbltvcC5vdGhlclRyZWVdLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAhbGFzdCB8fFxuICAgICAgICAgICAgICAobGFzdC5uZXh0U2libGluZyA9PT0gdGhpcy5jaGlsZHJlbltvcC50cmVlICsgaW5kZXhTaGlmdF0uZG9tICYmXG4gICAgICAgICAgICAgICAgcmUubGFzdClcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICA7KHsgbGFzdCB9ID0gcmUpXG4gICAgICAgICAgICAgIGlmIChyZS5wb3NzaWJsZVJlcGxhY2UpIHtcbiAgICAgICAgICAgICAgICBsYXN0RWxtSW5zZXJ0ZWQgPSByZS5wb3NzaWJsZVJlcGxhY2UuY3VyIGFzIEVsZW1lbnQgfCB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICBsYXN0RWxtRGVsZXRlZCA9IHJlLnBvc3NpYmxlUmVwbGFjZS5wcmV2XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbGFzdE9wID0gb3BcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGluc2VydGVkID0gaW5zZXJ0ZWQuY29uY2F0KHJlLmluc2VydGVkKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhvcGVyYXRpb25zKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgb3BlcmF0aW9ucycpXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGxhc3RPcCAmJiBsYXN0T3AudHlwZSAhPT0gJ2knICYmIGxhc3RFbG1JbnNlcnRlZCAmJiBsYXN0RWxtRGVsZXRlZCkge1xuICAgICAgcG9zc2libGVSZXBsYWNlID0ge1xuICAgICAgICBjdXI6IGxhc3RFbG1JbnNlcnRlZCxcbiAgICAgICAgcHJldjogbGFzdEVsbURlbGV0ZWQsXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGxhc3QsXG4gICAgICBpbnNlcnRlZCxcbiAgICAgIHBvc3NpYmxlUmVwbGFjZSxcbiAgICB9XG4gIH1cblxuICBpbnNlcnQoaTogbnVtYmVyLCB0cmVlOiBXcmFwcGVkRG9tVHJlZSwgcmVwPzogV3JhcHBlZERvbVRyZWUpIHtcbiAgICBjb25zdCBkb20gPSB0cmVlLmRvbS5jbG9uZU5vZGUodHJ1ZSlcbiAgICBpZiAoaSA9PT0gdGhpcy5kb20uY2hpbGROb2Rlcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZG9tLmFwcGVuZENoaWxkKGRvbSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kb20uaW5zZXJ0QmVmb3JlKGRvbSwgdGhpcy5kb20uY2hpbGROb2Rlc1tpXSlcbiAgICB9XG5cbiAgICBjb25zdCBjdHJlZSA9IG5ldyBXcmFwcGVkRG9tVHJlZShkb20gYXMgRWxlbWVudCwgZmFsc2UsIHJlcClcbiAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpLCAwLCBjdHJlZSlcbiAgICByZXR1cm4gdGhpcy5kb20uY2hpbGROb2Rlc1tpXVxuICB9XG5cbiAgcmVtb3ZlKGk6IG51bWJlcikge1xuICAgIHRoaXMuZG9tLnJlbW92ZUNoaWxkKHRoaXMuZG9tLmNoaWxkTm9kZXNbaV0pXG4gICAgdGhpcy5jaGlsZHJlbltpXS5yZW1vdmVTZWxmKClcbiAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpLCAxKVxuICAgIHJldHVybiB0aGlzLmRvbS5jaGlsZE5vZGVzW2kgLSAxXVxuICB9XG5cbiAgcHJpdmF0ZSBkaWZmKFxuICAgIG90aGVyVHJlZTogV3JhcHBlZERvbVRyZWUsXG4gICAgdG1heD86IG51bWJlcixcbiAgKToge1xuICAgIHNjb3JlOiBudW1iZXJcbiAgICBvcGVyYXRpb25zPzogT3BlcmF0aW9uW11cbiAgfSB7XG4gICAgbGV0IGlcbiAgICBpZiAodGhpcy5lcXVhbFRvKG90aGVyVHJlZSkpIHtcbiAgICAgIHJldHVybiB7IHNjb3JlOiAwLCBvcGVyYXRpb25zOiB1bmRlZmluZWQgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmNhbm5vdFJlcGxhY2VXaXRoKG90aGVyVHJlZSkpIHtcbiAgICAgIHJldHVybiB7IHNjb3JlOiAxIC8gMCwgb3BlcmF0aW9uczogdW5kZWZpbmVkIH1cbiAgICB9XG5cbiAgICBjb25zdCBrZXkgPSBvdGhlclRyZWUuaGFzaFxuICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLmRpZmZIYXNoKS5pbmNsdWRlcyhrZXkudG9TdHJpbmcoKSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmRpZmZIYXNoW2tleV1cbiAgICB9XG5cbiAgICBpZiAodG1heCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0bWF4ID0gMTAwMDAwXG4gICAgfVxuICAgIGlmICh0bWF4IDw9IDApIHtcbiAgICAgIHJldHVybiB7IHNjb3JlOiAwIH1cbiAgICB9XG5cbiAgICBsZXQgb2Zmc2V0ID0gMFxuICAgIGNvbnN0IGZvcndhcmRTZWFyY2ggPSAob2Zmc2V0OiBudW1iZXIpID0+XG4gICAgICBvZmZzZXQgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aCAmJlxuICAgICAgb2Zmc2V0IDwgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAmJlxuICAgICAgdGhpcy5jaGlsZHJlbltvZmZzZXRdLmVxdWFsVG8ob3RoZXJUcmVlLmNoaWxkcmVuW29mZnNldF0pXG4gICAgd2hpbGUgKGZvcndhcmRTZWFyY2gob2Zmc2V0KSkge1xuICAgICAgb2Zmc2V0KytcbiAgICB9XG5cbiAgICBjb25zdCBkcCA9IG5ldyBUd29EaW1BcnJheTxudW1iZXI+KFxuICAgICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggKyAxIC0gb2Zmc2V0LFxuICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCArIDEgLSBvZmZzZXQsXG4gICAgKVxuICAgIGNvbnN0IHAgPSBuZXcgVHdvRGltQXJyYXk8bnVtYmVyPihcbiAgICAgIHRoaXMuY2hpbGRyZW4ubGVuZ3RoICsgMSAtIG9mZnNldCxcbiAgICAgIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggKyAxIC0gb2Zmc2V0LFxuICAgIClcbiAgICBkcC5zZXQoMCwgMCwgMClcblxuICAgIGxldCBzdW0gPSAwXG4gICAgLy8gQmVjYXVzZSBjb2ZmZXNjcmlwdHMgYWxsb3dzIGJpZGVyY3Rpb25hbCBsb29wcyB3ZSBuZWVkIHRoaXMgY29uZGl0aW9uXG4gICAgLy8gZ2F1cmQgdG8gcHJldmVudCBhIGRlY3JlYXNpbmcgYXJyYXkgbGlzdFxuICAgIGlmIChvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0ID4gMSkge1xuICAgICAgbGV0IGFzYzogYm9vbGVhblxuICAgICAgbGV0IGVuZDogbnVtYmVyXG4gICAgICBmb3IgKFxuICAgICAgICBpID0gMSwgZW5kID0gb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCAtIDEsIGFzYyA9IDEgPD0gZW5kO1xuICAgICAgICBhc2MgPyBpIDw9IGVuZCA6IGkgPj0gZW5kO1xuICAgICAgICBhc2MgPyBpKysgOiBpLS1cbiAgICAgICkge1xuICAgICAgICBkcC5zZXQoMCwgaSwgc3VtKVxuICAgICAgICBwLnNldCgwLCBpLCBpIC0gMSlcbiAgICAgICAgc3VtICs9IG90aGVyVHJlZS5jaGlsZHJlbltpICsgb2Zmc2V0XS5zaXplXG4gICAgICB9XG4gICAgfVxuICAgIGlmIChvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0ID4gMCkge1xuICAgICAgZHAuc2V0KDAsIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIHN1bSlcbiAgICAgIHAuc2V0KFxuICAgICAgICAwLFxuICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LFxuICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldCxcbiAgICAgIClcbiAgICB9XG5cbiAgICBzdW0gPSAwXG4gICAgLy8gQmVjYXVzZSBjb2ZmZXNjcmlwdHMgYWxsb3dzIGJpZGVyY3Rpb25hbCBsb29wcyB3ZSBuZWVkIHRoaXMgY29uZGl0aW9uXG4gICAgLy8gZ2F1cmQgdG8gcHJldmVudCBhIGRlY3JlYXNpbmcgYXJyYXkgbGlzdFxuICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCA+IDEpIHtcbiAgICAgIGxldCBhc2MxOiBib29sZWFuXG4gICAgICBsZXQgZW5kMTogbnVtYmVyXG4gICAgICBmb3IgKFxuICAgICAgICBpID0gMSwgZW5kMSA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0IC0gMSwgYXNjMSA9IDEgPD0gZW5kMTtcbiAgICAgICAgYXNjMSA/IGkgPD0gZW5kMSA6IGkgPj0gZW5kMTtcbiAgICAgICAgYXNjMSA/IGkrKyA6IGktLVxuICAgICAgKSB7XG4gICAgICAgIGRwLnNldChpLCAwLCBzdW0pXG4gICAgICAgIHAuc2V0KGksIDAsIChpIC0gMSkgKiBwLmNvbClcbiAgICAgICAgc3VtICs9IHRoaXMuY2hpbGRyZW5baSArIG9mZnNldF0uc2l6ZVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQpIHtcbiAgICAgIGRwLnNldCh0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCwgMCwgc3VtKVxuICAgICAgcC5zZXQoXG4gICAgICAgIHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LFxuICAgICAgICAwLFxuICAgICAgICAodGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxIC0gb2Zmc2V0KSAqIHAuY29sLFxuICAgICAgKVxuICAgIH1cblxuICAgIGNvbnN0IGdldFNjb3JlID0gKGk6IG51bWJlciwgajogbnVtYmVyLCBtYXg/OiBudW1iZXIpOiBudW1iZXIgPT4ge1xuICAgICAgY29uc3QgcmVzID0gZHAuZ2V0KGksIGopXG4gICAgICBpZiAocmVzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgfVxuICAgICAgaWYgKG1heCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG1heCA9IDEgLyAwXG4gICAgICB9XG4gICAgICBpZiAobWF4IDw9IDApIHtcbiAgICAgICAgcmV0dXJuIDEgLyAwXG4gICAgICB9XG5cbiAgICAgIGxldCB2YWwgPSBtYXhcbiAgICAgIGNvbnN0IGJvdW5kID0gbWF4XG4gICAgICBjb25zdCBzdWJkaWZmID0gdGhpcy5jaGlsZHJlbltpIC0gMSArIG9mZnNldF0uZGlmZihcbiAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW2ogLSAxICsgb2Zmc2V0XSxcbiAgICAgICAgYm91bmQsXG4gICAgICApLnNjb3JlXG4gICAgICBsZXQgZm9yY2UgPSBmYWxzZVxuICAgICAgaWYgKFxuICAgICAgICBzdWJkaWZmIDwgYm91bmQgJiZcbiAgICAgICAgc3ViZGlmZiArIDEgPFxuICAgICAgICAgIHRoaXMuY2hpbGRyZW5baSAtIDEgKyBvZmZzZXRdLnNpemUgK1xuICAgICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW2ogLSAxICsgb2Zmc2V0XS5zaXplXG4gICAgICApIHtcbiAgICAgICAgZm9yY2UgPSB0cnVlXG4gICAgICB9XG4gICAgICB2YWwgPSBnZXRTY29yZShpIC0gMSwgaiAtIDEsIGJvdW5kIC0gc3ViZGlmZikgKyBzdWJkaWZmXG4gICAgICBsZXQgcHJldiA9IHAuZ2V0SW5kKGkgLSAxLCBqIC0gMSlcblxuICAgICAgaWYgKCFmb3JjZSkge1xuICAgICAgICBsZXQgb3RoZXIgPVxuICAgICAgICAgIGdldFNjb3JlKFxuICAgICAgICAgICAgaSAtIDEsXG4gICAgICAgICAgICBqLFxuICAgICAgICAgICAgTWF0aC5taW4odmFsLCBtYXgpIC0gdGhpcy5jaGlsZHJlbltpIC0gMSArIG9mZnNldF0uc2l6ZSxcbiAgICAgICAgICApICsgdGhpcy5jaGlsZHJlbltpIC0gMSArIG9mZnNldF0uc2l6ZVxuICAgICAgICBpZiAob3RoZXIgPCB2YWwpIHtcbiAgICAgICAgICBwcmV2ID0gcC5nZXRJbmQoaSAtIDEsIGopXG4gICAgICAgICAgdmFsID0gb3RoZXJcbiAgICAgICAgfVxuXG4gICAgICAgIG90aGVyID1cbiAgICAgICAgICBnZXRTY29yZShcbiAgICAgICAgICAgIGksXG4gICAgICAgICAgICBqIC0gMSxcbiAgICAgICAgICAgIE1hdGgubWluKHZhbCwgbWF4KSAtIG90aGVyVHJlZS5jaGlsZHJlbltqIC0gMSArIG9mZnNldF0uc2l6ZSxcbiAgICAgICAgICApICsgb3RoZXJUcmVlLmNoaWxkcmVuW2ogLSAxICsgb2Zmc2V0XS5zaXplXG4gICAgICAgIGlmIChvdGhlciA8IHZhbCkge1xuICAgICAgICAgIHByZXYgPSBwLmdldEluZChpLCBqIC0gMSlcbiAgICAgICAgICB2YWwgPSBvdGhlclxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICh2YWwgPj0gbWF4KSB7XG4gICAgICAgIHZhbCA9IDEgLyAwXG4gICAgICB9XG5cbiAgICAgIGRwLnNldChpLCBqLCB2YWwpXG4gICAgICBwLnNldChpLCBqLCBwcmV2KVxuICAgICAgcmV0dXJuIHZhbFxuICAgIH1cblxuICAgIGNvbnN0IHNjb3JlID0gZ2V0U2NvcmUoXG4gICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICAgIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgICB0bWF4LFxuICAgIClcbiAgICBjb25zdCBvcGVyYXRpb25zOiBPcGVyYXRpb25bXSA9IFtdXG5cbiAgICBsZXQgY3VyID0gcC5nZXRJbmQoXG4gICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICAgIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgKVxuICAgIGxldCBjciA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldFxuICAgIGxldCBjYyA9IG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSAxIC0gb2Zmc2V0XG5cbiAgICB3aGlsZSAocC5yYXdHZXQoY3VyKSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBwcmV2ID0gcC5yYXdHZXQoY3VyKSFcbiAgICAgIGNvbnN0IHJjID0gcC5nZXQyREluZChwcmV2KVxuICAgICAgY29uc3QgcHIgPSByYy5yIC0gMVxuICAgICAgY29uc3QgcGMgPSByYy5jIC0gMVxuXG4gICAgICBpZiAocHIgPT09IGNyKSB7XG4gICAgICAgIG9wZXJhdGlvbnMudW5zaGlmdCh7XG4gICAgICAgICAgdHlwZTogJ2knLFxuICAgICAgICAgIG90aGVyVHJlZTogY2MgKyBvZmZzZXQsXG4gICAgICAgICAgcG9zOiBjciArIDEgKyBvZmZzZXQsXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2UgaWYgKHBjID09PSBjYykge1xuICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgIHR5cGU6ICdkJyxcbiAgICAgICAgICB0cmVlOiBjciArIG9mZnNldCxcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG9wID0gdGhpcy5jaGlsZHJlbltjciArIG9mZnNldF0uZGlmZihcbiAgICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW5bY2MgKyBvZmZzZXRdLFxuICAgICAgICApLm9wZXJhdGlvbnNcbiAgICAgICAgaWYgKG9wICYmIG9wLmxlbmd0aCkge1xuICAgICAgICAgIG9wZXJhdGlvbnMudW5zaGlmdCh7XG4gICAgICAgICAgICB0eXBlOiAncicsXG4gICAgICAgICAgICB0cmVlOiBjciArIG9mZnNldCxcbiAgICAgICAgICAgIG90aGVyVHJlZTogY2MgKyBvZmZzZXQsXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY3VyID0gcHJldlxuICAgICAgY3IgPSBwclxuICAgICAgY2MgPSBwY1xuICAgIH1cblxuICAgIHRoaXMuZGlmZkhhc2hba2V5XSA9IHtcbiAgICAgIHNjb3JlLFxuICAgICAgb3BlcmF0aW9ucyxcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5kaWZmSGFzaFtrZXldXG4gIH1cblxuICBlcXVhbFRvKG90aGVyVHJlZTogV3JhcHBlZERvbVRyZWUpIHtcbiAgICByZXR1cm4gdGhpcy5kb20uaXNFcXVhbE5vZGUob3RoZXJUcmVlLmRvbSlcbiAgfVxuXG4gIGNhbm5vdFJlcGxhY2VXaXRoKG90aGVyVHJlZTogV3JhcHBlZERvbVRyZWUpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5pc1RleHQgfHxcbiAgICAgIG90aGVyVHJlZS5pc1RleHQgfHxcbiAgICAgIHRoaXMudGFnTmFtZSAhPT0gb3RoZXJUcmVlLnRhZ05hbWUgfHxcbiAgICAgIHRoaXMuY2xhc3NOYW1lICE9PSBvdGhlclRyZWUuY2xhc3NOYW1lIHx8XG4gICAgICB0aGlzLmNsYXNzTmFtZSA9PT0gJ21hdGgnIHx8XG4gICAgICB0aGlzLmNsYXNzTmFtZSA9PT0gJ2F0b20tdGV4dC1lZGl0b3InIHx8XG4gICAgICB0aGlzLnRhZ05hbWUgPT09ICdBJyB8fFxuICAgICAgKHRoaXMudGFnTmFtZSA9PT0gJ0lNRycgJiYgIXRoaXMuZG9tLmlzRXF1YWxOb2RlKG90aGVyVHJlZS5kb20pKVxuICAgIClcbiAgfVxuXG4gIGdldENvbnRlbnQoKSB7XG4gICAgaWYgKHRoaXMuZG9tLm91dGVySFRNTCkge1xuICAgICAgcmV0dXJuIHRoaXMuZG9tLm91dGVySFRNTFxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy50ZXh0RGF0YVxuICAgIH1cbiAgfVxuXG4gIHJlbW92ZVNlbGYoKSB7XG4gICAgaGFzaFRvW3RoaXMuaGFzaF0gPSB1bmRlZmluZWRcbiAgICB0aGlzLmNoaWxkcmVuICYmXG4gICAgICB0aGlzLmNoaWxkcmVuLmZvckVhY2goKGMpID0+IHtcbiAgICAgICAgYy5yZW1vdmVTZWxmKClcbiAgICAgIH0pXG4gIH1cbn1cbiJdfQ==