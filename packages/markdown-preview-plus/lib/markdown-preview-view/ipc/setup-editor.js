"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const electron_1 = require("electron");
const request_handler_1 = require("./request-handler");
const util_1 = require("../../util");
const should_scroll_sync_1 = require("./should-scroll-sync");
class RemoteEditorServer {
    constructor(editor) {
        this.editor = editor;
        this.disposables = new atom_1.CompositeDisposable();
        this.windowId = electron_1.remote.getCurrentWindow().id;
        this.destroyTimeoutLength = 60000;
        this.usageCounter = 0;
        this.eventHandlers = {
            scrollToBufferRange: ([min, max]) => {
                if (min === 0) {
                    this.editor.scrollToBufferPosition([min, 0]);
                }
                else if (max >= this.editor.getLastBufferRow() - 1) {
                    this.editor.scrollToBufferPosition([max, 0]);
                }
                else {
                    const range = atom_1.Range.fromObject([[min, 0], [max, 0]]);
                    this.editor.scrollToScreenRange(this.editor.screenRangeForBufferRange(range), {
                        center: false,
                    });
                }
            },
            destroy: () => {
                this.usageCounter -= 1;
                if (this.usageCounter <= 0) {
                    this.resetTimeout();
                    console.debug(`Scheduled disposal of remote-editor listener for ${this.windowId}/${this.editor.id}`);
                    this.destroyTimeout = window.setTimeout(() => {
                        this.dispose();
                    }, this.destroyTimeoutLength);
                }
            },
            init: () => {
                this.usageCounter += 1;
                this.resetTimeout();
                return {
                    path: this.editor.getPath(),
                    title: this.editor.getTitle(),
                    grammar: this.editor.getGrammar().scopeName,
                    text: this.editor.getText(),
                };
            },
            openSource: (row) => {
                if (row !== undefined) {
                    this.editor.setCursorBufferPosition([row, 0]);
                }
                electron_1.remote.getCurrentWindow().focus();
                const pane = atom.workspace.paneForItem(this.editor);
                if (!pane)
                    return;
                pane.activateItem(this.editor);
                pane.activate();
            },
        };
        console.debug(`Created remote-editor listener for ${this.windowId}/${this.editor.id}`);
        this.disposables.add(new request_handler_1.RequestHandler(this.windowId, editor.id, this.eventHandlers));
        this.handleEditorEvents();
    }
    static create(editor) {
        const res = RemoteEditorServer.editorMap.get(editor);
        if (res)
            return res;
        const newRes = new RemoteEditorServer(editor);
        RemoteEditorServer.editorMap.set(editor, newRes);
        return newRes;
    }
    dispose() {
        RemoteEditorServer.editorMap.delete(this.editor);
        this.disposables.dispose();
        console.debug(`Disposed remote-editor listener for ${this.windowId}/${this.editor.id}`);
    }
    resetTimeout() {
        if (this.destroyTimeout !== undefined) {
            window.clearTimeout(this.destroyTimeout);
            this.destroyTimeout = undefined;
            console.debug(`Cancelled disposal of remote-editor listener for ${this.windowId}/${this.editor.id}`);
        }
    }
    handleEditorEvents() {
        this.disposables.add(this.editor.getBuffer().onDidStopChanging(() => {
            if (util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
            if (util_1.atomConfig().syncConfig.syncPreviewOnChange) {
                this.emit('syncPreview', this.editor.getCursorBufferPosition().row);
            }
        }), this.editor.onDidChangePath(() => {
            this.emit('changePath', {
                path: this.editor.getPath(),
                title: this.editor.getTitle(),
            });
        }), this.editor.onDidChangeGrammar((grammar) => {
            this.emit('changeGrammar', grammar.scopeName);
        }), this.editor.onDidDestroy(() => {
            this.dispose();
            if (util_1.atomConfig().previewConfig.closePreviewWithEditor) {
                this.emit('destroy', undefined);
            }
        }), this.editor.getBuffer().onDidSave(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
        }), this.editor.getBuffer().onDidReload(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
        }), atom.views.getView(this.editor).onDidChangeScrollTop(() => {
            if (!should_scroll_sync_1.shouldScrollSync('editor'))
                return;
            const [first, last] = this.editor.getVisibleRowRange();
            const firstLine = this.editor.bufferRowForScreenRow(first);
            const lastLine = this.editor.bufferRowForScreenRow(last);
            this.emit('scrollSync', [firstLine, lastLine]);
        }), atom.commands.add(atom.views.getView(this.editor), {
            'markdown-preview-plus:sync-preview': () => {
                this.emit('syncPreview', this.editor.getCursorBufferPosition().row);
            },
        }));
    }
    emit(event, arg) {
        electron_1.remote.ipcMain.emit('markdown-preview-plus:editor-event', {
            editorId: this.editor.id,
            windowId: this.windowId,
            event,
            arg,
        });
    }
}
RemoteEditorServer.editorMap = new WeakMap();
exports.RemoteEditorServer = RemoteEditorServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAtZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy9pcGMvc2V0dXAtZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQTZEO0FBQzdELHVDQUFpQztBQUNqQyx1REFBa0Q7QUFDbEQscUNBQXVDO0FBQ3ZDLDZEQUF1RDtBQWtCdkQ7SUEyREUsWUFBcUMsTUFBa0I7UUFBbEIsV0FBTSxHQUFOLE1BQU0sQ0FBWTtRQXpEdEMsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDdkMsYUFBUSxHQUFHLGlCQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLENBQUE7UUFDdkMseUJBQW9CLEdBQUcsS0FBSyxDQUFBO1FBQ3JDLGlCQUFZLEdBQUcsQ0FBQyxDQUFBO1FBRWhCLGtCQUFhLEdBQUc7WUFDdEIsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQW1CLEVBQUUsRUFBRTtnQkFDcEQsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO29CQUNiLElBQUksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDN0M7cUJBQU0sSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsRUFBRTtvQkFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO2lCQUM3QztxQkFBTTtvQkFDTCxNQUFNLEtBQUssR0FBRyxZQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO29CQUNwRCxJQUFJLENBQUMsTUFBTSxDQUFDLG1C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O0FBRDFFLGdEQTJKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRFZGl0b3IsIENvbXBvc2l0ZURpc3Bvc2FibGUsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IHJlbW90ZSB9IGZyb20gJ2VsZWN0cm9uJ1xuaW1wb3J0IHsgUmVxdWVzdEhhbmRsZXIgfSBmcm9tICcuL3JlcXVlc3QtaGFuZGxlcidcbmltcG9ydCB7IGF0b21Db25maWcgfSBmcm9tICcuLi8uLi91dGlsJ1xuaW1wb3J0IHsgc2hvdWxkU2Nyb2xsU3luYyB9IGZyb20gJy4vc2hvdWxkLXNjcm9sbC1zeW5jJ1xuaW1wb3J0IHsgSVBDRXZlbnRzIH0gZnJvbSAnLi9ldmVudC1oYW5kbGVyJ1xuXG4vKiBOT1RFOiBXZWlyZCByZWZlcmVuY2UgY291bnRpbmcgYW5kIFdlYWtNYXAgYXJlIGhlcmUgYmVjYXVzZVxuICogdGhlcmUgY2FuIGJlIGluIHRoZW9yeSBtdWx0aXBsZSB3aW5kb3dzIHdpdGhcbiAqIE1hcmtkb3duUHJldmlld1ZpZXdFZGl0b3JSZW1vdGUgcmVmZXJlbmNpbmcgdGhlIHNhbWVcbiAqIGVkaXRvciBieSB3aW5kb3dJZC9lZGl0b3JJZCwgd2hpY2ggd291bGQgbGVhZCB0b1xuICogbXVsdGlwbGUgdHJpZ2dlcnMgaWYgbmV3IFwic2VydmVyXCIgd291bGQgYmUgY3JlYXRlZCBmb3IgZXZlcnkgbmV3XG4gKiBwcmV2aWV3IGluc3RhbmNlO1xuICogV2VpcmQgZGVmZXJyZWQgZGlzcG9zYWwgaXMgaGVyZSBiZWNhdXNlIG5ldy13aW5kb3cgZXhlY3V0ZWQgb25cbiAqIE1hcmtkb3duUHJldmlld1ZpZXdFZGl0b3JSZW1vdGUgd2lsbCBmaXJzdCBkZXN0cm95IHRoZSBjdXJyZW50XG4gKiBpbnN0YW5jZSwgYW5kIG9ubHkgdGhlbiwgYWZ0ZXIgYSBuZXcgQXRvbSB3aW5kb3cgaW5pdGlhbGl6ZXMsXG4gKiB3aWxsIGNyZWF0ZSBhIG5ldyBvbmUuIFdoaWNoIG1pZ2h0IGVhc2lseSB0YWtlIHRlbnMgb2Ygc2Vjb25kcy5cbiAqIFdoYXQgbWFrZXMgdGhpcyBldmVuIG1vcmUgY29tcGxpY2F0ZWQsIHRoZXJlIGlzIG5vIHNhbmUgd2F5IHRvXG4gKiBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgUmVtb3RlRWRpdG9yU2VydmVyIHJlbW90ZWx5OyBoZW5jZSxcbiAqIGl0IHdhaXRzIGp1c3QgaW4gY2FzZSBuZXcgY2xpZW50cyBhcHBlYXIgYmVmb3JlIGRpc3Bvc2luZyBvZiBpdHNlbGYuXG4gKi9cblxuZXhwb3J0IGNsYXNzIFJlbW90ZUVkaXRvclNlcnZlciB7XG4gIHByaXZhdGUgc3RhdGljIGVkaXRvck1hcCA9IG5ldyBXZWFrTWFwPFRleHRFZGl0b3IsIFJlbW90ZUVkaXRvclNlcnZlcj4oKVxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBwcml2YXRlIHJlYWRvbmx5IHdpbmRvd0lkID0gcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5pZFxuICBwcml2YXRlIHJlYWRvbmx5IGRlc3Ryb3lUaW1lb3V0TGVuZ3RoID0gNjAwMDBcbiAgcHJpdmF0ZSB1c2FnZUNvdW50ZXIgPSAwXG4gIHByaXZhdGUgZGVzdHJveVRpbWVvdXQ6IG51bWJlciB8IHVuZGVmaW5lZFxuICBwcml2YXRlIGV2ZW50SGFuZGxlcnMgPSB7XG4gICAgc2Nyb2xsVG9CdWZmZXJSYW5nZTogKFttaW4sIG1heF06IFtudW1iZXIsIG51bWJlcl0pID0+IHtcbiAgICAgIGlmIChtaW4gPT09IDApIHtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWluLCAwXSlcbiAgICAgIH0gZWxzZSBpZiAobWF4ID49IHRoaXMuZWRpdG9yLmdldExhc3RCdWZmZXJSb3coKSAtIDEpIHtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWF4LCAwXSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJhbmdlID0gUmFuZ2UuZnJvbU9iamVjdChbW21pbiwgMF0sIFttYXgsIDBdXSlcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9TY3JlZW5SYW5nZShcbiAgICAgICAgICB0aGlzLmVkaXRvci5zY3JlZW5SYW5nZUZvckJ1ZmZlclJhbmdlKHJhbmdlKSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBjZW50ZXI6IGZhbHNlLFxuICAgICAgICAgIH0sXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9LFxuICAgIGRlc3Ryb3k6ICgpID0+IHtcbiAgICAgIHRoaXMudXNhZ2VDb3VudGVyIC09IDFcbiAgICAgIGlmICh0aGlzLnVzYWdlQ291bnRlciA8PSAwKSB7XG4gICAgICAgIHRoaXMucmVzZXRUaW1lb3V0KClcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhcbiAgICAgICAgICBgU2NoZWR1bGVkIGRpc3Bvc2FsIG9mIHJlbW90ZS1lZGl0b3IgbGlzdGVuZXIgZm9yICR7dGhpcy53aW5kb3dJZH0vJHtcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yLmlkXG4gICAgICAgICAgfWAsXG4gICAgICAgIClcbiAgICAgICAgdGhpcy5kZXN0cm95VGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLmRpc3Bvc2UoKVxuICAgICAgICB9LCB0aGlzLmRlc3Ryb3lUaW1lb3V0TGVuZ3RoKVxuICAgICAgfVxuICAgIH0sXG4gICAgaW5pdDogKCkgPT4ge1xuICAgICAgdGhpcy51c2FnZUNvdW50ZXIgKz0gMVxuICAgICAgdGhpcy5yZXNldFRpbWVvdXQoKVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGF0aDogdGhpcy5lZGl0b3IuZ2V0UGF0aCgpLFxuICAgICAgICB0aXRsZTogdGhpcy5lZGl0b3IuZ2V0VGl0bGUoKSxcbiAgICAgICAgZ3JhbW1hcjogdGhpcy5lZGl0b3IuZ2V0R3JhbW1hcigpLnNjb3BlTmFtZSxcbiAgICAgICAgdGV4dDogdGhpcy5lZGl0b3IuZ2V0VGV4dCgpLFxuICAgICAgfVxuICAgIH0sXG4gICAgb3BlblNvdXJjZTogKHJvdz86IG51bWJlcikgPT4ge1xuICAgICAgaWYgKHJvdyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMuZWRpdG9yLnNldEN1cnNvckJ1ZmZlclBvc2l0aW9uKFtyb3csIDBdKVxuICAgICAgfVxuICAgICAgcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5mb2N1cygpXG4gICAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0odGhpcy5lZGl0b3IpXG4gICAgICBpZiAoIXBhbmUpIHJldHVyblxuICAgICAgcGFuZS5hY3RpdmF0ZUl0ZW0odGhpcy5lZGl0b3IpXG4gICAgICBwYW5lLmFjdGl2YXRlKClcbiAgICB9LFxuICB9XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGVkaXRvcjogVGV4dEVkaXRvcikge1xuICAgIGNvbnNvbGUuZGVidWcoXG4gICAgICBgQ3JlYXRlZCByZW1vdGUtZWRpdG9yIGxpc3RlbmVyIGZvciAke3RoaXMud2luZG93SWR9LyR7dGhpcy5lZGl0b3IuaWR9YCxcbiAgICApXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBuZXcgUmVxdWVzdEhhbmRsZXIodGhpcy53aW5kb3dJZCwgZWRpdG9yLmlkLCB0aGlzLmV2ZW50SGFuZGxlcnMpLFxuICAgIClcbiAgICB0aGlzLmhhbmRsZUVkaXRvckV2ZW50cygpXG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGNyZWF0ZShlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgICBjb25zdCByZXMgPSBSZW1vdGVFZGl0b3JTZXJ2ZXIuZWRpdG9yTWFwLmdldChlZGl0b3IpXG4gICAgaWYgKHJlcykgcmV0dXJuIHJlc1xuICAgIGNvbnN0IG5ld1JlcyA9IG5ldyBSZW1vdGVFZGl0b3JTZXJ2ZXIoZWRpdG9yKVxuICAgIFJlbW90ZUVkaXRvclNlcnZlci5lZGl0b3JNYXAuc2V0KGVkaXRvciwgbmV3UmVzKVxuICAgIHJldHVybiBuZXdSZXNcbiAgfVxuXG4gIHB1YmxpYyBkaXNwb3NlKCkge1xuICAgIFJlbW90ZUVkaXRvclNlcnZlci5lZGl0b3JNYXAuZGVsZXRlKHRoaXMuZWRpdG9yKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgY29uc29sZS5kZWJ1ZyhcbiAgICAgIGBEaXNwb3NlZCByZW1vdGUtZWRpdG9yIGxpc3RlbmVyIGZvciAke3RoaXMud2luZG93SWR9LyR7dGhpcy5lZGl0b3IuaWR9YCxcbiAgICApXG4gIH1cblxuICBwcml2YXRlIHJlc2V0VGltZW91dCgpIHtcbiAgICBpZiAodGhpcy5kZXN0cm95VGltZW91dCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuZGVzdHJveVRpbWVvdXQpXG4gICAgICB0aGlzLmRlc3Ryb3lUaW1lb3V0ID0gdW5kZWZpbmVkXG4gICAgICBjb25zb2xlLmRlYnVnKFxuICAgICAgICBgQ2FuY2VsbGVkIGRpc3Bvc2FsIG9mIHJlbW90ZS1lZGl0b3IgbGlzdGVuZXIgZm9yICR7dGhpcy53aW5kb3dJZH0vJHtcbiAgICAgICAgICB0aGlzLmVkaXRvci5pZFxuICAgICAgICB9YCxcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUVkaXRvckV2ZW50cygpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkU3RvcENoYW5naW5nKCgpID0+IHtcbiAgICAgICAgaWYgKGF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmxpdmVVcGRhdGUpIHtcbiAgICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZVRleHQnLCB0aGlzLmVkaXRvci5nZXRUZXh0KCkpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGF0b21Db25maWcoKS5zeW5jQ29uZmlnLnN5bmNQcmV2aWV3T25DaGFuZ2UpIHtcbiAgICAgICAgICB0aGlzLmVtaXQoJ3N5bmNQcmV2aWV3JywgdGhpcy5lZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKS5yb3cpXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgdGhpcy5lZGl0b3Iub25EaWRDaGFuZ2VQYXRoKCgpID0+IHtcbiAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2VQYXRoJywge1xuICAgICAgICAgIHBhdGg6IHRoaXMuZWRpdG9yLmdldFBhdGgoKSxcbiAgICAgICAgICB0aXRsZTogdGhpcy5lZGl0b3IuZ2V0VGl0bGUoKSxcbiAgICAgICAgfSlcbiAgICAgIH0pLFxuICAgICAgdGhpcy5lZGl0b3Iub25EaWRDaGFuZ2VHcmFtbWFyKChncmFtbWFyKSA9PiB7XG4gICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlR3JhbW1hcicsIGdyYW1tYXIuc2NvcGVOYW1lKVxuICAgICAgfSksXG4gICAgICB0aGlzLmVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3Bvc2UoKVxuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcuY2xvc2VQcmV2aWV3V2l0aEVkaXRvcikge1xuICAgICAgICAgIHRoaXMuZW1pdCgnZGVzdHJveScsIHVuZGVmaW5lZClcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICB0aGlzLmVkaXRvci5nZXRCdWZmZXIoKS5vbkRpZFNhdmUoKCkgPT4ge1xuICAgICAgICBpZiAoIWF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmxpdmVVcGRhdGUpIHtcbiAgICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZVRleHQnLCB0aGlzLmVkaXRvci5nZXRUZXh0KCkpXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRSZWxvYWQoKCkgPT4ge1xuICAgICAgICBpZiAoIWF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmxpdmVVcGRhdGUpIHtcbiAgICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZVRleHQnLCB0aGlzLmVkaXRvci5nZXRUZXh0KCkpXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgYXRvbS52aWV3cy5nZXRWaWV3KHRoaXMuZWRpdG9yKS5vbkRpZENoYW5nZVNjcm9sbFRvcCgoKSA9PiB7XG4gICAgICAgIGlmICghc2hvdWxkU2Nyb2xsU3luYygnZWRpdG9yJykpIHJldHVyblxuICAgICAgICBjb25zdCBbZmlyc3QsIGxhc3RdID0gdGhpcy5lZGl0b3IuZ2V0VmlzaWJsZVJvd1JhbmdlKClcbiAgICAgICAgY29uc3QgZmlyc3RMaW5lID0gdGhpcy5lZGl0b3IuYnVmZmVyUm93Rm9yU2NyZWVuUm93KGZpcnN0KVxuICAgICAgICBjb25zdCBsYXN0TGluZSA9IHRoaXMuZWRpdG9yLmJ1ZmZlclJvd0ZvclNjcmVlblJvdyhsYXN0KVxuICAgICAgICB0aGlzLmVtaXQoJ3Njcm9sbFN5bmMnLCBbZmlyc3RMaW5lLCBsYXN0TGluZV0pXG4gICAgICB9KSxcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvciksIHtcbiAgICAgICAgJ21hcmtkb3duLXByZXZpZXctcGx1czpzeW5jLXByZXZpZXcnOiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5lbWl0KCdzeW5jUHJldmlldycsIHRoaXMuZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCkucm93KVxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBlbWl0PFQgZXh0ZW5kcyBrZXlvZiBJUENFdmVudHM+KGV2ZW50OiBULCBhcmc6IElQQ0V2ZW50c1tUXSkge1xuICAgIHJlbW90ZS5pcGNNYWluLmVtaXQoJ21hcmtkb3duLXByZXZpZXctcGx1czplZGl0b3ItZXZlbnQnLCB7XG4gICAgICBlZGl0b3JJZDogdGhpcy5lZGl0b3IuaWQsXG4gICAgICB3aW5kb3dJZDogdGhpcy53aW5kb3dJZCxcbiAgICAgIGV2ZW50LFxuICAgICAgYXJnLFxuICAgIH0pXG4gIH1cbn1cbiJdfQ==