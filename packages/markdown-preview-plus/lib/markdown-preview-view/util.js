"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function* getStyles(context) {
    const elements = atom.styles.getStyleElements();
    for (const element of elements) {
        if (context === undefined || element.getAttribute('context') === context) {
            yield element.innerText;
        }
    }
}
function getClientStyle(file) {
    return atom.themes.loadStylesheet(path.join(__dirname, '..', '..', 'styles-client', `${file}.less`));
}
function getUserStyles() {
    const el = atom.styles.styleElementsBySourcePath[atom.styles.getUserStyleSheetPath()];
    if (!el)
        return [];
    return [el.innerText];
}
exports.getUserStyles = getUserStyles;
function getSyntaxTheme(themeName) {
    if (themeName !== '') {
        const themes = atom.themes.getLoadedThemes();
        if (themes) {
            const [theme] = themes.filter((x) => x.name === themeName);
            if (theme) {
                const stshts = theme
                    .getStylesheetPaths()
                    .map((p) => atom.themes.loadStylesheet(p));
                return processEditorStyles(stshts);
            }
        }
        atom.notifications.addWarning('Failed to load syntax theme', {
            detail: `Markdown-preview-plus couldn't find '${themeName}'`,
        });
    }
    return processEditorStyles(getStyles('atom-text-editor'));
}
function* getActivePackageStyles(packageName) {
    const pack = atom.packages.getActivePackage(packageName);
    if (!pack)
        return undefined;
    const stylesheets = pack.getStylesheetPaths();
    for (const ss of stylesheets) {
        const element = atom.styles.styleElementsBySourcePath[ss];
        if (element)
            yield element.innerText;
    }
}
function getPreviewStyles(display) {
    if (getStylesOverride)
        return getStylesOverride(display);
    const styles = [];
    if (display) {
        const globalStyles = atom.styles.styleElementsBySourcePath['global-text-editor-styles'];
        if (globalStyles) {
            styles.push(...processWorkspaceStyles([globalStyles.innerText]));
        }
        styles.push(getClientStyle('editor-global-font'));
        const packList = util_1.atomConfig().importPackageStyles;
        if (packList.includes('*')) {
            styles.push(...processEditorStyles(getStyles()));
            styles.push(getClientStyle('patch'));
        }
        else {
            for (const pack of packList) {
                styles.push(...processEditorStyles(getActivePackageStyles(pack)));
            }
            if (packList.includes('fonts')) {
                const fontsVar = atom.styles.styleElementsBySourcePath['fonts-package-editorfont'];
                if (fontsVar)
                    styles.push(...processEditorStyles([fontsVar.innerText]));
            }
        }
    }
    styles.push(getClientStyle('generic'));
    if (display)
        styles.push(getClientStyle('display'));
    if (util_1.atomConfig().useGitHubStyle) {
        styles.push(getClientStyle('github'));
    }
    else {
        styles.push(getClientStyle('default'));
    }
    styles.push(...getSyntaxTheme(util_1.atomConfig().syntaxThemeName));
    styles.push(...processEditorStyles(getUserStyles()));
    return styles;
}
exports.getPreviewStyles = getPreviewStyles;
function* processEditorStyles(styles) {
    for (const style of styles) {
        yield style.replace(/\batom-text-editor\b/g, 'pre.editor-colors');
    }
}
function* processWorkspaceStyles(styles) {
    for (const style of styles) {
        yield style.replace(/\batom-workspace\b/g, ':root');
    }
}
function getMarkdownPreviewCSS() {
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return getPreviewStyles(false)
        .join('\n')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'atom-text-editor';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
function buildLineMap(tokens) {
    const lineMap = {};
    const tokenTagCount = {};
    tokenTagCount[0] = {};
    for (const token of tokens) {
        if (token.hidden)
            continue;
        if (token.map == null)
            continue;
        const tag = decodeTag(token);
        if (tag === null)
            continue;
        if (token.nesting === 1) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
            tokenTagCount[token.level + 1] = {};
        }
        else if (token.nesting === 0) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
        }
        const ttc = tokenTagCount[token.level][tag];
        tokenTagCount[token.level][tag] = ttc ? ttc + 1 : 1;
    }
    return lineMap;
}
exports.buildLineMap = buildLineMap;
function mathJaxScript(texConfig) {
    return `\
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    extensions: ["[a11y]/accessibility-menu.js"],
    'HTML-CSS': {
      availableFonts: [],
      webFont: 'TeX',
      undefinedFamily: ${JSON.stringify(util_1.atomConfig().mathConfig.undefinedFamily)},
      mtextFontInherit: true,
    },
    TeX: ${JSON.stringify(texConfig, undefined, 2)},
    showMathMenu: true
  });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>`;
}
function mkHtml(title, html, renderLaTeX, texConfig) {
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = mathJaxScript(texConfig);
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSS()}</style>
${html.head.innerHTML}
  </head>
  <body>
    ${html.body.innerHTML}
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQW1EO0FBRW5ELFNBQWdCLFdBQVcsQ0FBQyxRQUFnQjtJQUMxQyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUU7UUFDcEQsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLFFBQVEsRUFBRTtZQUMxQixPQUFPLE1BQU0sQ0FBQTtTQUNkO0tBQ0Y7SUFDRCxPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDO0FBUEQsa0NBT0M7QUFHRCxJQUFJLGlCQUFpQixHQUF3QyxTQUFTLENBQUE7QUFFdEUsU0FBZ0Isc0JBQXNCLENBQUMsQ0FBMkI7SUFDaEUsaUJBQWlCLEdBQUcsQ0FBQyxDQUFBO0FBQ3ZCLENBQUM7QUFGRCx3REFFQztBQUVELFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxPQUF1QjtJQUN6QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUE7SUFFL0MsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUU7UUFDOUIsSUFBSSxPQUFPLEtBQUssU0FBUyxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEtBQUssT0FBTyxFQUFFO1lBQ3hFLE1BQU0sT0FBTyxDQUFDLFNBQVMsQ0FBQTtTQUN4QjtLQUNGO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLElBQVk7SUFDbEMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxDQUNsRSxDQUFBO0FBQ0gs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QUM5QixJQUFJLFdBQVcsRUFBRTtRQUNmLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQTtLQUM5QztTQUFNO1FBQ0wsa0JBQWtCLEdBQUcsRUFBRSxDQUFBO0tBQ3hCO0lBQ0QsT0FBTzs7Ozs7YUFLSSxLQUFLLFdBQVcsa0JBQWtCO2FBQ2xDLHFCQUFxQixFQUFFO0VBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUzs7O01BR2YsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTOzs7Q0FHeEIsQ0FBQTtBQUNELENBQUM7QUExQkQsd0JBMEJDO0FBRUQsU0FBZ0IsT0FBTyxDQUFDLElBQVk7SUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDN0MsSUFBSSxJQUFJO1FBQUUsb0JBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7QUFDakQsQ0FBQztBQUhELDBCQUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGV4dEVkaXRvciB9IGZyb20gJ2F0b20nXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcydcbmltcG9ydCB7IFRva2VuIH0gZnJvbSAnbWFya2Rvd24taXQnXG5pbXBvcnQgeyBoYW5kbGVQcm9taXNlLCBhdG9tQ29uZmlnIH0gZnJvbSAnLi4vdXRpbCdcblxuZXhwb3J0IGZ1bmN0aW9uIGVkaXRvckZvcklkKGVkaXRvcklkOiBudW1iZXIpOiBUZXh0RWRpdG9yIHwgdW5kZWZpbmVkIHtcbiAgZm9yIChjb25zdCBlZGl0b3Igb2YgYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKSkge1xuICAgIGlmIChlZGl0b3IuaWQgPT09IGVkaXRvcklkKSB7XG4gICAgICByZXR1cm4gZWRpdG9yXG4gICAgfVxuICB9XG4gIHJldHVybiB1bmRlZmluZWRcbn1cblxuLy8gdGhpcyB3ZWlyZG5lc3MgYWxsb3dzIG92ZXJyaWRpbmcgaW4gdGVzdHNcbmxldCBnZXRTdHlsZXNPdmVycmlkZTogdHlwZW9mIGdldFByZXZpZXdTdHlsZXMgfCB1bmRlZmluZWQgPSB1bmRlZmluZWRcblxuZXhwb3J0IGZ1bmN0aW9uIF9fc2V0R2V0U3R5bGVzT3ZlcnJpZGUoZj86IHR5cGVvZiBnZXRQcmV2aWV3U3R5bGVzKSB7XG4gIGdldFN0eWxlc092ZXJyaWRlID0gZlxufVxuXG5mdW5jdGlvbiogZ2V0U3R5bGVzKGNvbnRleHQ/OiBzdHJpbmcgfCBudWxsKTogSXRlcmFibGVJdGVyYXRvcjxzdHJpbmc+IHtcbiAgY29uc3QgZWxlbWVudHMgPSBhdG9tLnN0eWxlcy5nZXRTdHlsZUVsZW1lbnRzKClcblxuICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgZWxlbWVudHMpIHtcbiAgICBpZiAoY29udGV4dCA9PT0gdW5kZWZpbmVkIHx8IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjb250ZXh0JykgPT09IGNvbnRleHQpIHtcbiAgICAgIHlpZWxkIGVsZW1lbnQuaW5uZXJUZXh0XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldENsaWVudFN0eWxlKGZpbGU6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBhdG9tLnRoZW1lcy5sb2FkU3R5bGVzaGVldChcbiAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnc3R5bGVzLWNsaWVudCcsIGAke2ZpbGV9Lmxlc3NgKSxcbiAgKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VXNlclN0eWxlcygpIHtcbiAgY29uc3QgZWwgPVxuICAgIGF0b20uc3R5bGVzLnN0eWxlRWxlbWVudHNCeVNvdXJjZVBhdGhbYXRvbS5zdHlsZXMuZ2V0VXNlclN0eWxlU2hlZXRQYXRoKCldXG4gIGlmICghZWwpIHJldHVybiBbXVxuICByZXR1cm4gW2VsLmlubmVyVGV4dF1cbn1cblxuZnVuY3Rpb24gZ2V0U3ludGF4VGhlbWUodGhlbWVOYW1lOiBzdHJpbmcpOiBJdGVyYWJsZTxzdHJpbmc+IHtcbiAgaWYgKHRoZW1lTmFtZSAhPT0gJycpIHtcbiAgICBjb25zdCB0aGVtZXMgPSBhdG9tLnRoZW1lcy5nZXRMb2FkZWRUaGVtZXMoKVxuICAgIGlmICh0aGVtZXMpIHtcbiAgICAgIGNvbnN0IFt0aGVtZV0gPSB0aGVtZXMuZmlsdGVyKCh4KSA9PiB4Lm5hbWUgPT09IHRoZW1lTmFtZSlcbiAgICAgIGlmICh0aGVtZSkge1xuICAgICAgICBjb25zdCBzdHNodHMgPSB0aGVtZVxuICAgICAgICAgIC5nZXRTdHlsZXNoZWV0UGF0aHMoKVxuICAgICAgICAgIC5tYXAoKHApID0+IGF0b20udGhlbWVzLmxvYWRTdHlsZXNoZWV0KHApKVxuICAgICAgICByZXR1cm4gcHJvY2Vzc0VkaXRvclN0eWxlcyhzdHNodHMpXG4gICAgICB9XG4gICAgfVxuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKCdGYWlsZWQgdG8gbG9hZCBzeW50YXggdGhlbWUnLCB7XG4gICAgICBkZXRhaWw6IGBNYXJrZG93bi1wcmV2aWV3LXBsdXMgY291bGRuJ3QgZmluZCAnJHt0aGVtZU5hbWV9J2AsXG4gICAgfSlcbiAgfVxuICAvLyBkZWZhdWx0XG4gIHJldHVybiBwcm9jZXNzRWRpdG9yU3R5bGVzKGdldFN0eWxlcygnYXRvbS10ZXh0LWVkaXRvcicpKVxufVxuXG5mdW5jdGlvbiogZ2V0QWN0aXZlUGFja2FnZVN0eWxlcyhcbiAgcGFja2FnZU5hbWU6IHN0cmluZyxcbik6IEl0ZXJhYmxlSXRlcmF0b3I8c3RyaW5nPiB7XG4gIGNvbnN0IHBhY2sgPSBhdG9tLnBhY2thZ2VzLmdldEFjdGl2ZVBhY2thZ2UocGFja2FnZU5hbWUpXG4gIGlmICghcGFjaykgcmV0dXJuIHVuZGVmaW5lZFxuICBjb25zdCBzdHlsZXNoZWV0cyA9IHBhY2suZ2V0U3R5bGVzaGVldFBhdGhzKClcbiAgZm9yIChjb25zdCBzcyBvZiBzdHlsZXNoZWV0cykge1xuICAgIGNvbnN0IGVsZW1lbnQgPSBhdG9tLnN0eWxlcy5zdHlsZUVsZW1lbnRzQnlTb3VyY2VQYXRoW3NzXVxuICAgIGlmIChlbGVtZW50KSB5aWVsZCBlbGVtZW50LmlubmVyVGV4dFxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQcmV2aWV3U3R5bGVzKGRpc3BsYXk6IGJvb2xlYW4pOiBzdHJpbmdbXSB7XG4gIGlmIChnZXRTdHlsZXNPdmVycmlkZSkgcmV0dXJuIGdldFN0eWxlc092ZXJyaWRlKGRpc3BsYXkpXG4gIGNvbnN0IHN0eWxlcyA9IFtdXG4gIGlmIChkaXNwbGF5KSB7XG4gICAgLy8gZ2xvYmFsIGVkaXRvciBzdHlsZXNcbiAgICBjb25zdCBnbG9iYWxTdHlsZXMgPVxuICAgICAgYXRvbS5zdHlsZXMuc3R5bGVFbGVtZW50c0J5U291cmNlUGF0aFsnZ2xvYmFsLXRleHQtZWRpdG9yLXN0eWxlcyddXG4gICAgaWYgKGdsb2JhbFN0eWxlcykge1xuICAgICAgc3R5bGVzLnB1c2goLi4ucHJvY2Vzc1dvcmtzcGFjZVN0eWxlcyhbZ2xvYmFsU3R5bGVzLmlubmVyVGV4dF0pKVxuICAgIH1cbiAgICBzdHlsZXMucHVzaChnZXRDbGllbnRTdHlsZSgnZWRpdG9yLWdsb2JhbC1mb250JykpXG4gICAgLy8gcGFja2FnZSBzdHlsZXNcbiAgICBjb25zdCBwYWNrTGlzdCA9IGF0b21Db25maWcoKS5pbXBvcnRQYWNrYWdlU3R5bGVzXG4gICAgaWYgKHBhY2tMaXN0LmluY2x1ZGVzKCcqJykpIHtcbiAgICAgIHN0eWxlcy5wdXNoKC4uLnByb2Nlc3NFZGl0b3JTdHlsZXMoZ2V0U3R5bGVzKCkpKVxuICAgICAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ3BhdGNoJykpXG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAoY29uc3QgcGFjayBvZiBwYWNrTGlzdCkge1xuICAgICAgICBzdHlsZXMucHVzaCguLi5wcm9jZXNzRWRpdG9yU3R5bGVzKGdldEFjdGl2ZVBhY2thZ2VTdHlsZXMocGFjaykpKVxuICAgICAgfVxuICAgICAgLy8gZXhwbGljaXQgY29tcGF0aWJpbGl0eSB3aXRoIHRoZSBmb250cyBwYWNrYWdlXG4gICAgICBpZiAocGFja0xpc3QuaW5jbHVkZXMoJ2ZvbnRzJykpIHtcbiAgICAgICAgY29uc3QgZm9udHNWYXIgPVxuICAgICAgICAgIGF0b20uc3R5bGVzLnN0eWxlRWxlbWVudHNCeVNvdXJjZVBhdGhbJ2ZvbnRzLXBhY2thZ2UtZWRpdG9yZm9udCddXG4gICAgICAgIGlmIChmb250c1Zhcikgc3R5bGVzLnB1c2goLi4ucHJvY2Vzc0VkaXRvclN0eWxlcyhbZm9udHNWYXIuaW5uZXJUZXh0XSkpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ2dlbmVyaWMnKSlcbiAgaWYgKGRpc3BsYXkpIHN0eWxlcy5wdXNoKGdldENsaWVudFN0eWxlKCdkaXNwbGF5JykpXG4gIGlmIChhdG9tQ29uZmlnKCkudXNlR2l0SHViU3R5bGUpIHtcbiAgICBzdHlsZXMucHVzaChnZXRDbGllbnRTdHlsZSgnZ2l0aHViJykpXG4gIH0gZWxzZSB7XG4gICAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ2RlZmF1bHQnKSlcbiAgfVxuICBzdHlsZXMucHVzaCguLi5nZXRTeW50YXhUaGVtZShhdG9tQ29uZmlnKCkuc3ludGF4VGhlbWVOYW1lKSlcbiAgc3R5bGVzLnB1c2goLi4ucHJvY2Vzc0VkaXRvclN0eWxlcyhnZXRVc2VyU3R5bGVzKCkpKVxuICByZXR1cm4gc3R5bGVzXG59XG5cbmZ1bmN0aW9uKiBwcm9jZXNzRWRpdG9yU3R5bGVzKHN0eWxlczogSXRlcmFibGU8c3RyaW5nPikge1xuICBmb3IgKGNvbnN0IHN0eWxlIG9mIHN0eWxlcykge1xuICAgIHlpZWxkIHN0eWxlLnJlcGxhY2UoL1xcYmF0b20tdGV4dC1lZGl0b3JcXGIvZywgJ3ByZS5lZGl0b3ItY29sb3JzJylcbiAgfVxufVxuXG5mdW5jdGlvbiogcHJvY2Vzc1dvcmtzcGFjZVN0eWxlcyhzdHlsZXM6IEl0ZXJhYmxlPHN0cmluZz4pIHtcbiAgZm9yIChjb25zdCBzdHlsZSBvZiBzdHlsZXMpIHtcbiAgICB5aWVsZCBzdHlsZS5yZXBsYWNlKC9cXGJhdG9tLXdvcmtzcGFjZVxcYi9nLCAnOnJvb3QnKVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldE1hcmtkb3duUHJldmlld0NTUygpIHtcbiAgY29uc3QgY3NzVXJsUmVmRXhwID0gL3VybFxcKGF0b206XFwvXFwvbWFya2Rvd24tcHJldmlldy1wbHVzXFwvYXNzZXRzXFwvKC4qKVxcKS9cblxuICByZXR1cm4gZ2V0UHJldmlld1N0eWxlcyhmYWxzZSlcbiAgICAuam9pbignXFxuJylcbiAgICAucmVwbGFjZShjc3NVcmxSZWZFeHAsIGZ1bmN0aW9uKFxuICAgICAgX21hdGNoLFxuICAgICAgYXNzZXRzTmFtZTogc3RyaW5nLFxuICAgICAgX29mZnNldCxcbiAgICAgIF9zdHJpbmcsXG4gICAgKSB7XG4gICAgICAvLyBiYXNlNjQgZW5jb2RlIGFzc2V0c1xuICAgICAgY29uc3QgYXNzZXRQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2Fzc2V0cycsIGFzc2V0c05hbWUpXG4gICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBmcy5yZWFkRmlsZVN5bmMoYXNzZXRQYXRoLCAnYmluYXJ5JylcbiAgICAgIGNvbnN0IGJhc2U2NERhdGEgPSBuZXcgQnVmZmVyKG9yaWdpbmFsRGF0YSwgJ2JpbmFyeScpLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgcmV0dXJuIGB1cmwoJ2RhdGE6aW1hZ2UvanBlZztiYXNlNjQsJHtiYXNlNjREYXRhfScpYFxuICAgIH0pXG59XG5cbi8vXG4vLyBEZWNvZGUgdGFncyB1c2VkIGJ5IG1hcmtkb3duLWl0XG4vL1xuLy8gQHBhcmFtIHttYXJrZG93bi1pdC5Ub2tlbn0gdG9rZW4gRGVjb2RlIHRoZSB0YWcgb2YgdG9rZW4uXG4vLyBAcmV0dXJuIHtzdHJpbmd8bnVsbH0gRGVjb2RlZCB0YWcgb3IgYG51bGxgIGlmIHRoZSB0b2tlbiBoYXMgbm8gdGFnLlxuLy9cbmZ1bmN0aW9uIGRlY29kZVRhZyh0b2tlbjogVG9rZW4pOiBzdHJpbmcgfCBudWxsIHtcbiAgaWYgKHRva2VuLnRhZyA9PT0gJ21hdGgnKSB7XG4gICAgcmV0dXJuICdzcGFuJ1xuICB9XG4gIGlmICh0b2tlbi50YWcgPT09ICdjb2RlJykge1xuICAgIHJldHVybiAnYXRvbS10ZXh0LWVkaXRvcidcbiAgfVxuICBpZiAodG9rZW4udGFnID09PSAnJykge1xuICAgIHJldHVybiBudWxsXG4gIH1cbiAgcmV0dXJuIHRva2VuLnRhZ1xufVxuXG4vL1xuLy8gRGV0ZXJtaW5lIHBhdGggdG8gYSB0YXJnZXQgdG9rZW4uXG4vL1xuLy8gQHBhcmFtIHsobWFya2Rvd24taXQuVG9rZW4pW119IHRva2VucyBBcnJheSBvZiB0b2tlbnMgYXMgcmV0dXJuZWQgYnlcbi8vICAgYG1hcmtkb3duLWl0LnBhcnNlKClgLlxuLy8gQHBhcmFtIHtudW1iZXJ9IGxpbmUgTGluZSByZXByZXNlbnRpbmcgdGhlIHRhcmdldCB0b2tlbi5cbi8vIEByZXR1cm4geyh0YWc6IDx0YWc+LCBpbmRleDogPGluZGV4PilbXX0gQXJyYXkgcmVwcmVzZW50aW5nIGEgcGF0aCB0byB0aGVcbi8vICAgdGFyZ2V0IHRva2VuLiBUaGUgcm9vdCB0b2tlbiBpcyByZXByZXNlbnRlZCBieSB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGVcbi8vICAgYXJyYXkgYW5kIHRoZSB0YXJnZXQgdG9rZW4gYnkgdGhlIGxhc3QgZWxtZW50LiBFYWNoIGVsZW1lbnQgY29uc2lzdHMgb2YgYVxuLy8gICBgdGFnYCBhbmQgYGluZGV4YCByZXByZXNlbnRpbmcgaXRzIGluZGV4IGFtb25nc3QgaXRzIHNpYmxpbmcgdG9rZW5zIGluXG4vLyAgIGB0b2tlbnNgIG9mIHRoZSBzYW1lIGB0YWdgLiBgbGluZWAgd2lsbCBsaWUgYmV0d2VlbiB0aGUgcHJvcGVydGllc1xuLy8gICBgbWFwWzBdYCBhbmQgYG1hcFsxXWAgb2YgdGhlIHRhcmdldCB0b2tlbi5cbi8vXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRMaW5lTWFwKHRva2VuczogUmVhZG9ubHlBcnJheTxSZWFkb25seTxUb2tlbj4+KSB7XG4gIGNvbnN0IGxpbmVNYXA6IHsgW2xpbmU6IG51bWJlcl06IEFycmF5PHsgdGFnOiBzdHJpbmc7IGluZGV4OiBudW1iZXIgfT4gfSA9IHt9XG4gIGNvbnN0IHRva2VuVGFnQ291bnQ6IHsgW2xpbmU6IG51bWJlcl06IHsgW3RhZzogc3RyaW5nXTogbnVtYmVyIH0gfSA9IHt9XG4gIHRva2VuVGFnQ291bnRbMF0gPSB7fVxuXG4gIGZvciAoY29uc3QgdG9rZW4gb2YgdG9rZW5zKSB7XG4gICAgaWYgKHRva2VuLmhpZGRlbikgY29udGludWVcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c3RyaWN0LXR5cGUtcHJlZGljYXRlcyAvLyBUT0RPOiBjb21wbGFpbiBvbiBEVFxuICAgIGlmICh0b2tlbi5tYXAgPT0gbnVsbCkgY29udGludWVcblxuICAgIGNvbnN0IHRhZyA9IGRlY29kZVRhZyh0b2tlbilcbiAgICBpZiAodGFnID09PSBudWxsKSBjb250aW51ZVxuXG4gICAgaWYgKHRva2VuLm5lc3RpbmcgPT09IDEpIHtcbiAgICAgIC8vIG9wZW5pbmcgdGFnXG4gICAgICBmb3IgKGxldCBsaW5lID0gdG9rZW4ubWFwWzBdOyBsaW5lIDwgdG9rZW4ubWFwWzFdOyBsaW5lICs9IDEpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXNcbiAgICAgICAgaWYgKGxpbmVNYXBbbGluZV0gPT0gbnVsbCkgbGluZU1hcFtsaW5lXSA9IFtdXG4gICAgICAgIGxpbmVNYXBbbGluZV0ucHVzaCh7XG4gICAgICAgICAgdGFnOiB0YWcsXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gfHwgMCxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWwgKyAxXSA9IHt9XG4gICAgfSBlbHNlIGlmICh0b2tlbi5uZXN0aW5nID09PSAwKSB7XG4gICAgICAvLyBzZWxmLWNsb3NpbmcgdGFnXG4gICAgICBmb3IgKGxldCBsaW5lID0gdG9rZW4ubWFwWzBdOyBsaW5lIDwgdG9rZW4ubWFwWzFdOyBsaW5lICs9IDEpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXNcbiAgICAgICAgaWYgKGxpbmVNYXBbbGluZV0gPT0gbnVsbCkgbGluZU1hcFtsaW5lXSA9IFtdXG4gICAgICAgIGxpbmVNYXBbbGluZV0ucHVzaCh7XG4gICAgICAgICAgdGFnOiB0YWcsXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gfHwgMCxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgdHRjID0gdG9rZW5UYWdDb3VudFt0b2tlbi5sZXZlbF1bdGFnXVxuICAgIHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gPSB0dGMgPyB0dGMgKyAxIDogMVxuICB9XG5cbiAgcmV0dXJuIGxpbmVNYXBcbn1cblxuZnVuY3Rpb24gbWF0aEpheFNjcmlwdCh0ZXhDb25maWc6IE1hdGhKYXguVGVYSW5wdXRQcm9jZXNzb3IpIHtcbiAgcmV0dXJuIGBcXFxuPHNjcmlwdCB0eXBlPVwidGV4dC94LW1hdGhqYXgtY29uZmlnXCI+XG4gIE1hdGhKYXguSHViLkNvbmZpZyh7XG4gICAgamF4OiBbXCJpbnB1dC9UZVhcIixcIm91dHB1dC9IVE1MLUNTU1wiXSxcbiAgICBleHRlbnNpb25zOiBbXCJbYTExeV0vYWNjZXNzaWJpbGl0eS1tZW51LmpzXCJdLFxuICAgICdIVE1MLUNTUyc6IHtcbiAgICAgIGF2YWlsYWJsZUZvbnRzOiBbXSxcbiAgICAgIHdlYkZvbnQ6ICdUZVgnLFxuICAgICAgdW5kZWZpbmVkRmFtaWx5OiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICBhdG9tQ29uZmlnKCkubWF0aENvbmZpZy51bmRlZmluZWRGYW1pbHksXG4gICAgICApfSxcbiAgICAgIG10ZXh0Rm9udEluaGVyaXQ6IHRydWUsXG4gICAgfSxcbiAgICBUZVg6ICR7SlNPTi5zdHJpbmdpZnkodGV4Q29uZmlnLCB1bmRlZmluZWQsIDIpfSxcbiAgICBzaG93TWF0aE1lbnU6IHRydWVcbiAgfSk7XG48L3NjcmlwdD5cbjxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiIHNyYz1cImh0dHBzOi8vY2RuanMuY2xvdWRmbGFyZS5jb20vYWpheC9saWJzL21hdGhqYXgvMi43LjQvTWF0aEpheC5qc1wiPjwvc2NyaXB0PmBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1rSHRtbChcbiAgdGl0bGU6IHN0cmluZyxcbiAgaHRtbDogSFRNTERvY3VtZW50LFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgdGV4Q29uZmlnOiBNYXRoSmF4LlRlWElucHV0UHJvY2Vzc29yLFxuKSB7XG4gIGxldCBtYXliZU1hdGhKYXhTY3JpcHQ6IHN0cmluZ1xuICBpZiAocmVuZGVyTGFUZVgpIHtcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSBtYXRoSmF4U2NyaXB0KHRleENvbmZpZylcbiAgfSBlbHNlIHtcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSAnJ1xuICB9XG4gIHJldHVybiBgXFxcbjwhRE9DVFlQRSBodG1sPlxuPGh0bWw+XG4gIDxoZWFkPlxuICAgIDxtZXRhIGNoYXJzZXQ9XCJ1dGYtOFwiIC8+XG4gICAgPHRpdGxlPiR7dGl0bGV9PC90aXRsZT4ke21heWJlTWF0aEpheFNjcmlwdH1cbiAgICA8c3R5bGU+JHtnZXRNYXJrZG93blByZXZpZXdDU1MoKX08L3N0eWxlPlxuJHtodG1sLmhlYWQuaW5uZXJIVE1MfVxuICA8L2hlYWQ+XG4gIDxib2R5PlxuICAgICR7aHRtbC5ib2R5LmlubmVySFRNTH1cbiAgPC9ib2R5PlxuPC9odG1sPlxuYCAvLyBFbnN1cmUgdHJhaWxpbmcgbmV3bGluZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVzdHJveShpdGVtOiBvYmplY3QpIHtcbiAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVGb3JJdGVtKGl0ZW0pXG4gIGlmIChwYW5lKSBoYW5kbGVQcm9taXNlKHBhbmUuZGVzdHJveUl0ZW0oaXRlbSkpXG59XG4iXX0=