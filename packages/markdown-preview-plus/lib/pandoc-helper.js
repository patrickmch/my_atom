"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const CP = require("child_process");
const fs = require("fs");
const path = require("path");
const util_1 = require("./util");
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached !== null) {
            return cached;
        }
        try {
            return (cached = require.resolve('mathjax'));
        }
        catch (e) {
            return '';
        }
    };
})();
function findFileRecursive(filePath, fileName) {
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if (newPath !== filePath && !atom.project.getPaths().includes(newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
}
function setPandocOptions(filePath, renderMath) {
    const opts = { maxBuffer: Infinity };
    if (filePath !== undefined) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    const config = util_1.atomConfig().pandocConfig;
    const args = {
        from: config.pandocMarkdownFlavor,
        to: 'html',
        mathjax: renderMath ? mathjaxPath : undefined,
        filter: config.pandocFilters,
    };
    if (config.pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = filePath && findFileRecursive(filePath, config.pandocBIBFile);
        if (!bibFile) {
            bibFile = config.pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = filePath && findFileRecursive(filePath, config.pandocCSLFile);
        if (!cslFile) {
            cslFile = config.pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
}
function handleError(error, html, renderMath) {
    const err = new Error(error);
    err.html = handleSuccess(html, renderMath);
    throw err;
}
function handleMath(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>');
    });
    return doc.innerHTML;
}
function removeReferences(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach((elem) => {
        elem.remove();
    });
    return doc.innerHTML;
}
function handleSuccess(html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (util_1.atomConfig().pandocConfig.pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return html;
}
function handleResponse(error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
}
async function renderPandoc(text, filePath, renderMath) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    return new Promise((resolve, reject) => {
        const cp = CP.execFile(util_1.atomConfig().pandocConfig.pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    stack: error.stack,
                    dismissable: true,
                });
                reject(error);
            }
            try {
                const result = handleResponse(stderr || '', stdout || '', renderMath);
                resolve(result);
            }
            catch (e) {
                reject(e);
            }
        });
        cp.stdin.write(text);
        cp.stdin.end();
    });
}
exports.renderPandoc = renderPandoc;
function getArguments(iargs) {
    const args = [];
    for (const [key, val] of Object.entries(iargs)) {
        if (Array.isArray(val)) {
            args.push(...val.map((v) => `--${key}=${v}`));
        }
        else if (val) {
            args.push(`--${key}=${val}`);
        }
    }
    const res = [];
    for (const val of [...args, ...util_1.atomConfig().pandocConfig.pandocArguments]) {
        const newval = val.replace(/^(--[\w\-]+)\s(.+)$/i, '$1=$2');
        if (newval.substr(0, 1) === '-') {
            res.push(newval);
        }
    }
    return res;
}
exports.testing = {
    setPandocOptions,
    getArguments,
    findFileRecursive,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQW9DO0FBQ3BDLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsaUNBQW1DO0FBS25DLE1BQU0sY0FBYyxHQUFHLENBQUM7SUFDdEIsSUFBSSxNQUFNLEdBQWtCLElBQUksQ0FBQTtJQUNoQyxPQUFPO1FBQ0wsSUFBSSxNQUFNLEtBQUssSUFBSSxFQUFFO1lBQ25CLE9BQU8sTUFBTSxDQUFBO1NBQ2Q7UUFDRCxJQUFJO1lBQ0YsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUE7U0FDN0M7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLE9BQU8sRUFBRSxDQUFBO1NBQ1Y7SUFDSCxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUMsRUFBRSxDQUFBO0FBRUosU0FBUyxpQkFBaUIsQ0FBQyxRQUFnQixFQUFFLFFBQWdCO0lBQzNELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUNwRCxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDMUIsT0FBTyxPQUFPLENBQUE7S0FDZjtTQUFNO1FBQ0wsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDeEMsSUFBSSxPQUFPLEtBQUssUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdEUsT0FBTyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUE7U0FDNUM7YUFBTTtZQUNMLE9BQU8sS0FBSyxDQUFBO1NBQ2I7S0FD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QyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO1NBQzlDO2FBQU0sSUFBSSxHQUFHLEVBQUU7WUFDZCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUE7U0FDN0I7S0FDRjtJQUNELE1BQU0sR0FBRyxHQUFhLEVBQUUsQ0FBQTtJQUN4QixLQUFLLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUUsR0FBRyxpQkFBVSxFQUFFLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxFQUFFO1FBQ3pFLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDM0QsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUU7WUFDL0IsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtTQUNqQjtLQUNGO0lBQ0QsT0FBTyxHQUFHLENBQUE7QUFDWixDQUFDO0FBRVksUUFBQSxPQUFPLEdBQUc7SUFDckIsZ0JBQWdCO0lBQ2hCLFlBQVk7SUFDWixpQkFBaUI7Q0FDbEIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDUCA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKVxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbmltcG9ydCB7IGF0b21Db25maWcgfSBmcm9tICcuL3V0aWwnXG5cbi8qKlxuICogU2V0cyBsb2NhbCBtYXRoamF4UGF0aCBpZiBhdmFpbGFibGVcbiAqL1xuY29uc3QgZ2V0TWF0aEpheFBhdGggPSAoZnVuY3Rpb24oKSB7XG4gIGxldCBjYWNoZWQ6IHN0cmluZyB8IG51bGwgPSBudWxsXG4gIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICBpZiAoY2FjaGVkICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FjaGVkXG4gICAgfVxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gKGNhY2hlZCA9IHJlcXVpcmUucmVzb2x2ZSgnbWF0aGpheCcpKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiAnJ1xuICAgIH1cbiAgfVxufSkoKVxuXG5mdW5jdGlvbiBmaW5kRmlsZVJlY3Vyc2l2ZShmaWxlUGF0aDogc3RyaW5nLCBmaWxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHwgZmFsc2Uge1xuICBjb25zdCBiaWJGaWxlID0gcGF0aC5qb2luKGZpbGVQYXRoLCAnLi4vJywgZmlsZU5hbWUpXG4gIGlmIChmcy5leGlzdHNTeW5jKGJpYkZpbGUpKSB7XG4gICAgcmV0dXJuIGJpYkZpbGVcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5qb2luKGJpYkZpbGUsICcuLicpXG4gICAgaWYgKG5ld1BhdGggIT09IGZpbGVQYXRoICYmICFhdG9tLnByb2plY3QuZ2V0UGF0aHMoKS5pbmNsdWRlcyhuZXdQYXRoKSkge1xuICAgICAgcmV0dXJuIGZpbmRGaWxlUmVjdXJzaXZlKG5ld1BhdGgsIGZpbGVOYW1lKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cbn1cblxuLy8gZXhwb3J0ZWQgZm9yIHRlc3RzXG5leHBvcnQgaW50ZXJmYWNlIEFyZ3Mge1xuICBmcm9tOiBzdHJpbmdcbiAgdG86ICdodG1sJ1xuICBtYXRoamF4Pzogc3RyaW5nXG4gIGZpbHRlcjogc3RyaW5nW11cbiAgYmlibGlvZ3JhcGh5Pzogc3RyaW5nXG4gIGNzbD86IHN0cmluZ1xufVxuXG5mdW5jdGlvbiBzZXRQYW5kb2NPcHRpb25zKGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsIHJlbmRlck1hdGg6IGJvb2xlYW4pIHtcbiAgLy8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hdG9tLWNvbW11bml0eS9tYXJrZG93bi1wcmV2aWV3LXBsdXMvaXNzdWVzLzMxNlxuICBjb25zdCBvcHRzOiBDUC5FeGVjRmlsZU9wdGlvbnMgPSB7IG1heEJ1ZmZlcjogSW5maW5pdHkgfVxuICBpZiAoZmlsZVBhdGggIT09IHVuZGVmaW5lZCkge1xuICAgIG9wdHMuY3dkID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKVxuICB9XG4gIGNvbnN0IG1hdGhqYXhQYXRoID0gZ2V0TWF0aEpheFBhdGgoKVxuICBjb25zdCBjb25maWcgPSBhdG9tQ29uZmlnKCkucGFuZG9jQ29uZmlnXG4gIGNvbnN0IGFyZ3M6IEFyZ3MgPSB7XG4gICAgZnJvbTogY29uZmlnLnBhbmRvY01hcmtkb3duRmxhdm9yLFxuICAgIHRvOiAnaHRtbCcsXG4gICAgbWF0aGpheDogcmVuZGVyTWF0aCA/IG1hdGhqYXhQYXRoIDogdW5kZWZpbmVkLFxuICAgIGZpbHRlcjogY29uZmlnLnBhbmRvY0ZpbHRlcnMsXG4gIH1cbiAgaWYgKGNvbmZpZy5wYW5kb2NCaWJsaW9ncmFwaHkpIHtcbiAgICBhcmdzLmZpbHRlci5wdXNoKCdwYW5kb2MtY2l0ZXByb2MnKVxuICAgIGxldCBiaWJGaWxlID0gZmlsZVBhdGggJiYgZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGgsIGNvbmZpZy5wYW5kb2NCSUJGaWxlKVxuICAgIGlmICghYmliRmlsZSkge1xuICAgICAgYmliRmlsZSA9IGNvbmZpZy5wYW5kb2NCSUJGaWxlRmFsbGJhY2tcbiAgICB9XG4gICAgYXJncy5iaWJsaW9ncmFwaHkgPSBiaWJGaWxlID8gYmliRmlsZSA6IHVuZGVmaW5lZFxuICAgIGxldCBjc2xGaWxlID0gZmlsZVBhdGggJiYgZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGgsIGNvbmZpZy5wYW5kb2NDU0xGaWxlKVxuICAgIGlmICghY3NsRmlsZSkge1xuICAgICAgY3NsRmlsZSA9IGNvbmZpZy5wYW5kb2NDU0xGaWxlRmFsbGJhY2tcbiAgICB9XG4gICAgYXJncy5jc2wgPSBjc2xGaWxlID8gY3NsRmlsZSA6IHVuZGVmaW5lZFxuICB9XG4gIHJldHVybiB7IGFyZ3MsIG9wdHMgfVxufVxuXG4vKipcbiAqIEhhbmRsZSBlcnJvciByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtlcnJvcn0gUmV0dXJuZWQgZXJyb3JcbiAqIEBwYXJhbSB7c3RyaW5nfSBSZXR1cm5lZCBIVE1MXG4gKiBAcmV0dXJuIHthcnJheX0gd2l0aCBBcmd1bWVudHMgZm9yIGNhbGxiYWNrRnVuY3Rpb24gKGVycm9yIHNldCB0byBudWxsKVxuICovXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihlcnJvcjogc3RyaW5nLCBodG1sOiBzdHJpbmcsIHJlbmRlck1hdGg6IGJvb2xlYW4pOiBuZXZlciB7XG4gIGNvbnN0IGVyciA9IG5ldyBFcnJvcihlcnJvcikgYXMgRXJyb3IgJiB7IGh0bWw6IHN0cmluZyB9XG4gIGVyci5odG1sID0gaGFuZGxlU3VjY2VzcyhodG1sLCByZW5kZXJNYXRoKVxuICB0aHJvdyBlcnJcbn1cblxuLyoqXG4gKiBBZGp1c3RzIGFsbCBtYXRoIGVudmlyb25tZW50cyBpbiBIVE1MXG4gKiBAcGFyYW0ge3N0cmluZ30gSFRNTCB0byBiZSBhZGp1c3RlZFxuICogQHJldHVybiB7c3RyaW5nfSBIVE1MIHdpdGggYWRqdXN0ZWQgbWF0aCBlbnZpcm9ubWVudHNcbiAqL1xuZnVuY3Rpb24gaGFuZGxlTWF0aChodG1sOiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnLm1hdGgnKS5mb3JFYWNoKGZ1bmN0aW9uKGVsZW0pIHtcbiAgICBsZXQgbWF0aCA9IChlbGVtIGFzIEhUTUxFbGVtZW50KS5pbm5lclRleHRcbiAgICAvLyBTZXQgbW9kZSBpZiBpdCBpcyBibG9jayBtYXRoXG4gICAgY29uc3QgbW9kZSA9IG1hdGguaW5kZXhPZignXFxcXFsnKSA+IC0xID8gJzsgbW9kZT1kaXNwbGF5JyA6ICcnXG5cbiAgICAvLyBSZW1vdmUgc291cnJvdW5kaW5nIFxcWyBcXF0gYW5kIFxcKCBcXClcbiAgICBtYXRoID0gbWF0aC5yZXBsYWNlKC9cXFxcW1soKVxcXV0vZywgJycpXG4gICAgcmV0dXJuIChlbGVtLm91dGVySFRNTCA9XG4gICAgICAnPHNwYW4gY2xhc3M9XCJtYXRoXCI+JyArXG4gICAgICBgPHNjcmlwdCB0eXBlPSdtYXRoL3RleCR7bW9kZX0nPiR7bWF0aH08L3NjcmlwdD5gICtcbiAgICAgICc8L3NwYW4+JylcbiAgfSlcblxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG5mdW5jdGlvbiByZW1vdmVSZWZlcmVuY2VzKGh0bWw6IHN0cmluZykge1xuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnLnJlZmVyZW5jZXMnKS5mb3JFYWNoKChlbGVtKSA9PiB7XG4gICAgZWxlbS5yZW1vdmUoKVxuICB9KVxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG4vKipcbiAqIEhhbmRsZSBzdWNjZXNzZnVsIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0gUmV0dXJuZWQgSFRNTFxuICogQHJldHVybiBQb3NzaWJseSBtb2RpZmllZCByZXR1cm5lZCBIVE1MXG4gKi9cbmZ1bmN0aW9uIGhhbmRsZVN1Y2Nlc3MoaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKTogc3RyaW5nIHtcbiAgaWYgKHJlbmRlck1hdGgpIHtcbiAgICBodG1sID0gaGFuZGxlTWF0aChodG1sKVxuICB9XG4gIGlmIChhdG9tQ29uZmlnKCkucGFuZG9jQ29uZmlnLnBhbmRvY1JlbW92ZVJlZmVyZW5jZXMpIHtcbiAgICBodG1sID0gcmVtb3ZlUmVmZXJlbmNlcyhodG1sKVxuICB9XG4gIHJldHVybiBodG1sXG59XG5cbi8qKlxuICogSGFuZGxlIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0ge09iamVjdH0gZXJyb3IgaWYgdGhyb3duXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICovXG5mdW5jdGlvbiBoYW5kbGVSZXNwb25zZShlcnJvcjogc3RyaW5nLCBodG1sOiBzdHJpbmcsIHJlbmRlck1hdGg6IGJvb2xlYW4pIHtcbiAgaWYgKGVycm9yKSB7XG4gICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yLCBodG1sLCByZW5kZXJNYXRoKVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBoYW5kbGVTdWNjZXNzKGh0bWwsIHJlbmRlck1hdGgpXG4gIH1cbn1cblxuLyoqXG4gKiBSZW5kZXJzIG1hcmtkb3duIHdpdGggcGFuZG9jXG4gKiBAcGFyYW0ge3N0cmluZ30gZG9jdW1lbnQgaW4gbWFya2Rvd25cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gd2hldGhlciB0byByZW5kZXIgdGhlIG1hdGggd2l0aCBtYXRoamF4XG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFja0Z1bmN0aW9uXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW5kZXJQYW5kb2MoXG4gIHRleHQ6IHN0cmluZyxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgcmVuZGVyTWF0aDogYm9vbGVhbixcbik6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IHsgYXJncywgb3B0cyB9ID0gc2V0UGFuZG9jT3B0aW9ucyhmaWxlUGF0aCwgcmVuZGVyTWF0aClcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IGNwID0gQ1AuZXhlY0ZpbGUoXG4gICAgICBhdG9tQ29uZmlnKCkucGFuZG9jQ29uZmlnLnBhbmRvY1BhdGgsXG4gICAgICBnZXRBcmd1bWVudHMoYXJncyksXG4gICAgICBvcHRzLFxuICAgICAgZnVuY3Rpb24oZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlcnJvci50b1N0cmluZygpLCB7XG4gICAgICAgICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gICAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGhhbmRsZVJlc3BvbnNlKHN0ZGVyciB8fCAnJywgc3Rkb3V0IHx8ICcnLCByZW5kZXJNYXRoKVxuICAgICAgICAgIHJlc29sdmUocmVzdWx0KVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgcmVqZWN0KGUpXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKVxuICAgIGNwLnN0ZGluLndyaXRlKHRleHQpXG4gICAgY3Auc3RkaW4uZW5kKClcbiAgfSlcbn1cblxuZnVuY3Rpb24gZ2V0QXJndW1lbnRzKGlhcmdzOiBBcmdzKSB7XG4gIGNvbnN0IGFyZ3M6IHN0cmluZ1tdID0gW11cbiAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKGlhcmdzKSkge1xuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHtcbiAgICAgIGFyZ3MucHVzaCguLi52YWwubWFwKCh2KSA9PiBgLS0ke2tleX09JHt2fWApKVxuICAgIH0gZWxzZSBpZiAodmFsKSB7XG4gICAgICBhcmdzLnB1c2goYC0tJHtrZXl9PSR7dmFsfWApXG4gICAgfVxuICB9XG4gIGNvbnN0IHJlczogc3RyaW5nW10gPSBbXVxuICBmb3IgKGNvbnN0IHZhbCBvZiBbLi4uYXJncywgLi4uYXRvbUNvbmZpZygpLnBhbmRvY0NvbmZpZy5wYW5kb2NBcmd1bWVudHNdKSB7XG4gICAgY29uc3QgbmV3dmFsID0gdmFsLnJlcGxhY2UoL14oLS1bXFx3XFwtXSspXFxzKC4rKSQvaSwgJyQxPSQyJylcbiAgICBpZiAobmV3dmFsLnN1YnN0cigwLCAxKSA9PT0gJy0nKSB7XG4gICAgICByZXMucHVzaChuZXd2YWwpXG4gICAgfVxuICB9XG4gIHJldHVybiByZXNcbn1cblxuZXhwb3J0IGNvbnN0IHRlc3RpbmcgPSB7XG4gIHNldFBhbmRvY09wdGlvbnMsXG4gIGdldEFyZ3VtZW50cyxcbiAgZmluZEZpbGVSZWN1cnNpdmUsXG59XG4iXX0=