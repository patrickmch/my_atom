"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const CSON = require("season");
const fs = require("fs");
const util_1 = require("./util");
let isMathJaxDisabled = false;
function mathProcessor(domElements) {
    if (isMathJaxDisabled)
        return;
    if (window.MathJax) {
        window.MathJax.Hub.Queue(['Typeset', window.MathJax.Hub, domElements]);
    }
    else {
        loadMathJax(() => {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, domElements]);
        });
    }
}
exports.mathProcessor = mathProcessor;
function processHTMLString(html, callback) {
    if (isMathJaxDisabled) {
        callback(html);
        return;
    }
    const element = document.createElement('div');
    element.innerHTML = html;
    const compileProcessedHTMLString = function () {
        const msvgh = document.getElementById('MathJax_SVG_Hidden');
        const svgGlyphs = msvgh && msvgh.parentNode.cloneNode(true);
        if (svgGlyphs !== null) {
            element.insertBefore(svgGlyphs, element.firstChild);
        }
        return element.innerHTML;
    };
    const queueProcessHTMLString = () => {
        MathJax.Hub.Queue(['setRenderer', MathJax.Hub, 'SVG'], ['Typeset', MathJax.Hub, element], ['setRenderer', MathJax.Hub, 'HTML-CSS'], [
            () => {
                callback(compileProcessedHTMLString());
            },
        ]);
    };
    if (window.MathJax) {
        queueProcessHTMLString();
    }
    else {
        loadMathJax(queueProcessHTMLString);
    }
}
exports.processHTMLString = processHTMLString;
function disableMathJax(disable) {
    isMathJaxDisabled = disable;
}
function loadMathJax(listener) {
    const script = attachMathJax();
    if (listener) {
        script.addEventListener('load', () => {
            listener();
        });
    }
}
function attachMathJax() {
    if (!document.querySelector('script[src*="MathJax.js"]')) {
        return attachMathJaxInternal();
    }
    throw new Error('Duplicate attachMathJax call');
}
function resetMathJax() {
    for (const el of Array.from(document.querySelectorAll('script[src*="MathJax.js"]'))) {
        el.remove();
    }
    window.MathJax = undefined;
    delete window.MathJax;
}
exports.testing = {
    loadMathJax,
    resetMathJax,
    disableMathJax,
};
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
function getUserMacrosPath() {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
}
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object === undefined) {
            object = {};
        }
        if (error !== undefined) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack !== undefined ? error.stack : error}`);
            atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
        }
        return object;
    });
}
function loadUserMacros() {
    const userMacrosPath = getUserMacrosPath();
    if (util_1.isFileSync(userMacrosPath)) {
        return loadMacrosFile(userMacrosPath);
    }
    else {
        console.debug('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return loadMacrosFile(userMacrosPath);
    }
}
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function () {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    MathJax.Hub.Config({
        jax: ['input/TeX', 'output/HTML-CSS'],
        extensions: [],
        TeX: {
            extensions: [
                'AMSmath.js',
                'AMSsymbols.js',
                'noErrors.js',
                'noUndefined.js',
            ],
            Macros: userMacros,
        },
        'HTML-CSS': {
            availableFonts: [],
            webFont: 'TeX',
        },
        messageStyle: 'none',
        showMathMenu: false,
        skipStartupTypeset: true,
    });
    MathJax.Hub.Configured();
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
function attachMathJaxInternal() {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    const script = document.createElement('script');
    script.src = `${require.resolve('MathJax')}?delayStartupUntil=configured`;
    script.type = 'text/javascript';
    script.addEventListener('load', () => {
        configureMathJax();
    });
    document.getElementsByTagName('head')[0].appendChild(script);
    return script;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6QixpQ0FBbUM7QUFFbkMsSUFBSSxpQkFBaUIsR0FBRyxLQUFLLENBQUE7QUFTN0IsdUJBQThCLFdBQW1CO0lBQy9DLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDO1FBQUMsTUFBTSxDQUFBO0lBQzdCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFBO0lBQ3hFLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDZixPQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsRUFBRSxPQUFRLENBQUMsR0FBRyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUE7UUFDNUQsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0FBQ0gsQ0FBQztBQVRELHNDQVNDO0FBU0QsMkJBQ0UsSUFBWSxFQUNaLFFBQWtDO0lBRWxDLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztRQUN0QixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDZCxNQUFNLENBQUE7SUFDUixDQUFDO0lBQ0QsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUM3QyxPQUFPLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQTtJQUV4QixNQUFNLDBCQUEwQixHQUFHO1FBQ2pDLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FB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LENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFBO0lBR3pCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsdUNBQXVDLENBQUMsQ0FBQTtJQUN4RSxDQUFDO0FBQ0gsQ0FBQyxDQUFBO0FBS0Q7SUFFRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLHdDQUF3QyxDQUFDLENBQUE7SUFDdEUsQ0FBQztJQUdELE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDL0MsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLCtCQUErQixDQUFBO0lBQ3pFLE1BQU0sQ0FBQyxJQUFJLEdBQUcsaUJBQWlCLENBQUE7SUFDL0IsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUU7UUFDbkMsZ0JBQWdCLEVBQUUsQ0FBQTtJQUNwQixDQUFDLENBQUMsQ0FBQTtJQUNGLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUE7SUFFNUQsTUFBTSxDQUFDLE1BQU0sQ0FBQTtBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvL1xuLy8gbWF0aGpheC1oZWxwZXJcbi8vXG4vLyBUaGlzIG1vZHVsZSB3aWxsIGhhbmRsZSBsb2FkaW5nIHRoZSBNYXRoSmF4IGVudmlyb25tZW50IGFuZCBwcm92aWRlIGEgd3JhcHBlclxuLy8gZm9yIGNhbGxzIHRvIE1hdGhKYXggdG8gcHJvY2VzcyBMYVRlWCBlcXVhdGlvbnMuXG4vL1xuXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IENTT04gPSByZXF1aXJlKCdzZWFzb24nKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKVxuaW1wb3J0IHsgaXNGaWxlU3luYyB9IGZyb20gJy4vdXRpbCdcblxubGV0IGlzTWF0aEpheERpc2FibGVkID0gZmFsc2VcblxuLy9cbi8vIFByb2Nlc3MgRE9NIGVsZW1lbnRzIGZvciBMYVRlWCBlcXVhdGlvbnMgd2l0aCBNYXRoSmF4XG4vL1xuLy8gQHBhcmFtIGRvbUVsZW1lbnRzIEFuIGFycmF5IG9mIERPTSBlbGVtZW50cyB0byBiZSBwcm9jZXNzZWQgYnkgTWF0aEpheC4gU2VlXG4vLyAgIFtlbGVtZW50XShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudCkgZm9yXG4vLyAgIGRldGFpbHMgb24gRE9NIGVsZW1lbnRzLlxuLy9cbmV4cG9ydCBmdW5jdGlvbiBtYXRoUHJvY2Vzc29yKGRvbUVsZW1lbnRzOiBOb2RlW10pIHtcbiAgaWYgKGlzTWF0aEpheERpc2FibGVkKSByZXR1cm5cbiAgaWYgKHdpbmRvdy5NYXRoSmF4KSB7XG4gICAgd2luZG93Lk1hdGhKYXguSHViLlF1ZXVlKFsnVHlwZXNldCcsIHdpbmRvdy5NYXRoSmF4Lkh1YiwgZG9tRWxlbWVudHNdKVxuICB9IGVsc2Uge1xuICAgIGxvYWRNYXRoSmF4KCgpID0+IHtcbiAgICAgIE1hdGhKYXghLkh1Yi5RdWV1ZShbJ1R5cGVzZXQnLCBNYXRoSmF4IS5IdWIsIGRvbUVsZW1lbnRzXSlcbiAgICB9KVxuICB9XG59XG5cbi8vXG4vLyBQcm9jZXNzIG1hdGhzIGluIEhUTUwgZnJhZ21lbnQgd2l0aCBNYXRoSmF4XG4vL1xuLy8gQHBhcmFtIGh0bWwgQSBIVE1MIGZyYWdtZW50IHN0cmluZ1xuLy8gQHBhcmFtIGNhbGxiYWNrIEEgY2FsbGJhY2sgbWV0aG9kIHRoYXQgYWNjZXB0cyBhIHNpbmdsZSBwYXJhbWV0ZXIsIGEgSFRNTFxuLy8gICBmcmFnbWVudCBzdHJpbmcgdGhhdCBpcyB0aGUgcmVzdWx0IG9mIGh0bWwgcHJvY2Vzc2VkIGJ5IE1hdGhKYXhcbi8vXG5leHBvcnQgZnVuY3Rpb24gcHJvY2Vzc0hUTUxTdHJpbmcoXG4gIGh0bWw6IHN0cmluZyxcbiAgY2FsbGJhY2s6IChwcm9IVE1MOiBzdHJpbmcpID0+IGFueSxcbikge1xuICBpZiAoaXNNYXRoSmF4RGlzYWJsZWQpIHtcbiAgICBjYWxsYmFjayhodG1sKVxuICAgIHJldHVyblxuICB9XG4gIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWxcblxuICBjb25zdCBjb21waWxlUHJvY2Vzc2VkSFRNTFN0cmluZyA9IGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IG1zdmdoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ01hdGhKYXhfU1ZHX0hpZGRlbicpXG4gICAgY29uc3Qgc3ZnR2x5cGhzID0gbXN2Z2ggJiYgbXN2Z2gucGFyZW50Tm9kZSEuY2xvbmVOb2RlKHRydWUpXG4gICAgaWYgKHN2Z0dseXBocyAhPT0gbnVsbCkge1xuICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoc3ZnR2x5cGhzLCBlbGVtZW50LmZpcnN0Q2hpbGQpXG4gICAgfVxuICAgIHJldHVybiBlbGVtZW50LmlubmVySFRNTFxuICB9XG5cbiAgY29uc3QgcXVldWVQcm9jZXNzSFRNTFN0cmluZyA9ICgpID0+IHtcbiAgICBNYXRoSmF4IS5IdWIuUXVldWUoXG4gICAgICBbJ3NldFJlbmRlcmVyJywgTWF0aEpheCEuSHViLCAnU1ZHJ10sXG4gICAgICBbJ1R5cGVzZXQnLCBNYXRoSmF4IS5IdWIsIGVsZW1lbnRdLFxuICAgICAgWydzZXRSZW5kZXJlcicsIE1hdGhKYXghLkh1YiwgJ0hUTUwtQ1NTJ10sXG4gICAgICBbXG4gICAgICAgICgpID0+IHtcbiAgICAgICAgICBjYWxsYmFjayhjb21waWxlUHJvY2Vzc2VkSFRNTFN0cmluZygpKVxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICApXG4gIH1cblxuICBpZiAod2luZG93Lk1hdGhKYXgpIHtcbiAgICBxdWV1ZVByb2Nlc3NIVE1MU3RyaW5nKClcbiAgfSBlbHNlIHtcbiAgICBsb2FkTWF0aEpheChxdWV1ZVByb2Nlc3NIVE1MU3RyaW5nKVxuICB9XG59XG5cbi8vIEZvciB0ZXN0aW5nXG5mdW5jdGlvbiBkaXNhYmxlTWF0aEpheChkaXNhYmxlOiBib29sZWFuKSB7XG4gIGlzTWF0aEpheERpc2FibGVkID0gZGlzYWJsZVxufVxuXG4vL1xuLy8gTG9hZCBNYXRoSmF4IGVudmlyb25tZW50XG4vL1xuLy8gQHBhcmFtIGxpc3RlbmVyIG1ldGhvZCB0byBjYWxsIHdoZW4gdGhlIE1hdGhKYXggc2NyaXB0IHdhcyBiZWVuXG4vLyAgIGxvYWRlZCB0byB0aGUgd2luZG93LiBUaGUgbWV0aG9kIGlzIHBhc3NlZCBubyBhcmd1bWVudHMuXG4vL1xuZnVuY3Rpb24gbG9hZE1hdGhKYXgobGlzdGVuZXI/OiAoKSA9PiBhbnkpIHtcbiAgY29uc3Qgc2NyaXB0ID0gYXR0YWNoTWF0aEpheCgpXG4gIGlmIChsaXN0ZW5lcikge1xuICAgIHNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4ge1xuICAgICAgbGlzdGVuZXIoKVxuICAgIH0pXG4gIH1cbn1cblxuLy9cbi8vIEF0dGFjaCBtYWluIE1hdGhKYXggc2NyaXB0IHRvIHRoZSBkb2N1bWVudFxuLy9cbmZ1bmN0aW9uIGF0dGFjaE1hdGhKYXgoKSB7XG4gIGlmICghZG9jdW1lbnQucXVlcnlTZWxlY3Rvcignc2NyaXB0W3NyYyo9XCJNYXRoSmF4LmpzXCJdJykpIHtcbiAgICByZXR1cm4gYXR0YWNoTWF0aEpheEludGVybmFsKClcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoJ0R1cGxpY2F0ZSBhdHRhY2hNYXRoSmF4IGNhbGwnKVxufVxuXG4vL1xuLy8gUmVtb3ZlIE1hdGhKYXggZnJvbSB0aGUgZG9jdW1lbnQgYW5kIHJlc2V0IGF0dGFjaCBtZXRob2Rcbi8vXG5mdW5jdGlvbiByZXNldE1hdGhKYXgoKSB7XG4gIC8vIERldGFjaCBNYXRoSmF4IGZyb20gdGhlIGRvY3VtZW50XG4gIGZvciAoY29uc3QgZWwgb2YgQXJyYXkuZnJvbShcbiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdzY3JpcHRbc3JjKj1cIk1hdGhKYXguanNcIl0nKSxcbiAgKSkge1xuICAgIGVsLnJlbW92ZSgpXG4gIH1cbiAgd2luZG93Lk1hdGhKYXggPSB1bmRlZmluZWRcblxuICAvLyBSZXNldCBhdHRhY2ggZm9yIGFueSBzdWJzZXF1ZW50IGNhbGxzXG4gIGRlbGV0ZSB3aW5kb3cuTWF0aEpheFxufVxuXG5leHBvcnQgY29uc3QgdGVzdGluZyA9IHtcbiAgbG9hZE1hdGhKYXgsXG4gIHJlc2V0TWF0aEpheCxcbiAgZGlzYWJsZU1hdGhKYXgsXG59XG5cbi8vIHByaXZhdGVcblxuLy9cbi8vIERlZmluZSBzb21lIGZ1bmN0aW9ucyB0byBoZWxwIGdldCBhIGhvbGQgb2YgdGhlIHVzZXIncyBMYXRleFxuLy8gTWFjcm9zLlxuLy9cbmNvbnN0IG5hbWVQYXR0ZXJuID0gbmV3IFJlZ0V4cChgXFxcbl5bXmEtekEtWlxcXFxkXFxcXHNdJFxcXG58XFxcbl5bYS16QS1aXSokXFxcbmApIC8vIGxldHRlcnMsIGJ1dCBubyBudW1lcmFscy5cblxuZnVuY3Rpb24gZ2V0VXNlck1hY3Jvc1BhdGgoKTogc3RyaW5nIHtcbiAgY29uc3QgdXNlck1hY3Jvc1BhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwgPSBDU09OLnJlc29sdmUoXG4gICAgcGF0aC5qb2luKGF0b20uZ2V0Q29uZmlnRGlyUGF0aCgpLCAnbWFya2Rvd24tcHJldmlldy1wbHVzJyksXG4gIClcbiAgcmV0dXJuIHVzZXJNYWNyb3NQYXRoICE9IG51bGxcbiAgICA/IHVzZXJNYWNyb3NQYXRoXG4gICAgOiBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksICdtYXJrZG93bi1wcmV2aWV3LXBsdXMuY3NvbicpXG59XG5cbmZ1bmN0aW9uIGxvYWRNYWNyb3NGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBvYmplY3Qge1xuICBpZiAoIUNTT04uaXNPYmplY3RQYXRoKGZpbGVQYXRoKSkge1xuICAgIHJldHVybiB7fVxuICB9XG4gIHJldHVybiBDU09OLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgZnVuY3Rpb24oZXJyb3I/OiBFcnJvciwgb2JqZWN0Pzogb2JqZWN0KSB7XG4gICAgaWYgKG9iamVjdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBvYmplY3QgPSB7fVxuICAgIH1cbiAgICBpZiAoZXJyb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBgRXJyb3IgcmVhZGluZyBMYXRleCBNYWNyb3MgZmlsZSAnJHtmaWxlUGF0aH0nOiAke1xuICAgICAgICAgIGVycm9yLnN0YWNrICE9PSB1bmRlZmluZWQgPyBlcnJvci5zdGFjayA6IGVycm9yXG4gICAgICAgIH1gLFxuICAgICAgKVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGF0ZXggTWFjcm9zIGZyb20gJyR7ZmlsZVBhdGh9J2AsXG4gICAgICAgIHsgZGV0YWlsOiBlcnJvci5tZXNzYWdlLCBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgICAgKVxuICAgIH1cbiAgICByZXR1cm4gb2JqZWN0XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGxvYWRVc2VyTWFjcm9zKCkge1xuICBjb25zdCB1c2VyTWFjcm9zUGF0aCA9IGdldFVzZXJNYWNyb3NQYXRoKClcbiAgaWYgKGlzRmlsZVN5bmModXNlck1hY3Jvc1BhdGgpKSB7XG4gICAgcmV0dXJuIGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKVxuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuZGVidWcoXG4gICAgICAnQ3JlYXRpbmcgbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24sIHRoaXMgaXMgYSBvbmUtdGltZSBvcGVyYXRpb24uJyxcbiAgICApXG4gICAgY3JlYXRlTWFjcm9zVGVtcGxhdGUodXNlck1hY3Jvc1BhdGgpXG4gICAgcmV0dXJuIGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKVxuICB9XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZU1hY3Jvc1RlbXBsYXRlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgdGVtcGxhdGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2Fzc2V0cy9tYWNyb3MtdGVtcGxhdGUuY3NvbicpXG4gIGNvbnN0IHRlbXBsYXRlRmlsZSA9IGZzLnJlYWRGaWxlU3luYyh0ZW1wbGF0ZVBhdGgsICd1dGY4JylcbiAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgdGVtcGxhdGVGaWxlKVxufVxuXG5mdW5jdGlvbiBjaGVja01hY3JvcyhtYWNyb3NPYmplY3Q6IG9iamVjdCkge1xuICBmb3IgKGNvbnN0IG5hbWUgaW4gbWFjcm9zT2JqZWN0KSB7XG4gICAgY29uc3QgdmFsdWUgPSBtYWNyb3NPYmplY3RbbmFtZV1cbiAgICBpZiAoIW5hbWUubWF0Y2gobmFtZVBhdHRlcm4pIHx8ICF2YWx1ZU1hdGNoZXNQYXR0ZXJuKHZhbHVlKSkge1xuICAgICAgZGVsZXRlIG1hY3Jvc09iamVjdFtuYW1lXVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGFUZVggbWFjcm8gbmFtZWQgJyR7bmFtZX0nLiBQbGVhc2Ugc2VlIHRoZSBbTGFUZVggZ3VpZGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9HYWxhZGlyaXRoL21hcmtkb3duLXByZXZpZXctcGx1cy9ibG9iL21hc3Rlci9MQVRFWC5tZCNtYWNyby1uYW1lcylgLFxuICAgICAgICB7IGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgICApXG4gICAgfVxuICB9XG4gIHJldHVybiBtYWNyb3NPYmplY3Rcbn1cblxuZnVuY3Rpb24gdmFsdWVNYXRjaGVzUGF0dGVybih2YWx1ZTogYW55KSB7XG4gIC8vIERpZmZlcmVudCBjaGVjayBiYXNlZCBvbiB3aGV0aGVyIHZhbHVlIGlzIHN0cmluZyBvciBhcnJheVxuICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICBjb25zdCBtYWNyb0RlZmluaXRpb24gPSB2YWx1ZVswXVxuICAgIGNvbnN0IG51bWJlck9mQXJncyA9IHZhbHVlWzFdXG4gICAgaWYgKHR5cGVvZiBudW1iZXJPZkFyZ3MgPT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gbnVtYmVyT2ZBcmdzICUgMSA9PT0gMCAmJiB0eXBlb2YgbWFjcm9EZWZpbml0aW9uID09PSAnc3RyaW5nJ1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB0cnVlXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuLy8gQ29uZmlndXJlIE1hdGhKYXggZW52aXJvbm1lbnQuIFNpbWlsYXIgdG8gdGhlIFRlWC1BTVNfSFRNTCBjb25maWd1cmF0aW9uIHdpdGhcbi8vIGEgZmV3IHVubmVjZXNzYXJ5IGZlYXR1cmVzIHN0cmlwcGVkIGF3YXlcbi8vXG5jb25zdCBjb25maWd1cmVNYXRoSmF4ID0gZnVuY3Rpb24oKSB7XG4gIGxldCB1c2VyTWFjcm9zID0gbG9hZFVzZXJNYWNyb3MoKVxuICBpZiAodXNlck1hY3Jvcykge1xuICAgIHVzZXJNYWNyb3MgPSBjaGVja01hY3Jvcyh1c2VyTWFjcm9zKVxuICB9IGVsc2Uge1xuICAgIHVzZXJNYWNyb3MgPSB7fVxuICB9XG5cbiAgLy8gTm93IENvbmZpZ3VyZSBNYXRoSmF4XG4gIE1hdGhKYXghLkh1Yi5Db25maWcoe1xuICAgIGpheDogWydpbnB1dC9UZVgnLCAnb3V0cHV0L0hUTUwtQ1NTJ10sXG4gICAgZXh0ZW5zaW9uczogW10sXG4gICAgVGVYOiB7XG4gICAgICBleHRlbnNpb25zOiBbXG4gICAgICAgICdBTVNtYXRoLmpzJyxcbiAgICAgICAgJ0FNU3N5bWJvbHMuanMnLFxuICAgICAgICAnbm9FcnJvcnMuanMnLFxuICAgICAgICAnbm9VbmRlZmluZWQuanMnLFxuICAgICAgXSxcbiAgICAgIE1hY3JvczogdXNlck1hY3JvcyxcbiAgICB9LFxuICAgICdIVE1MLUNTUyc6IHtcbiAgICAgIGF2YWlsYWJsZUZvbnRzOiBbXSxcbiAgICAgIHdlYkZvbnQ6ICdUZVgnLFxuICAgIH0sXG4gICAgbWVzc2FnZVN0eWxlOiAnbm9uZScsXG4gICAgc2hvd01hdGhNZW51OiBmYWxzZSxcbiAgICBza2lwU3RhcnR1cFR5cGVzZXQ6IHRydWUsXG4gIH0pXG4gIE1hdGhKYXghLkh1Yi5Db25maWd1cmVkKClcblxuICAvLyBOb3RpZnkgdXNlciBNYXRoSmF4IGhhcyBsb2FkZWRcbiAgaWYgKGF0b20uaW5EZXZNb2RlKCkpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkU3VjY2VzcygnTG9hZGVkIG1hdGhzIHJlbmRlcmluZyBlbmdpbmUgTWF0aEpheCcpXG4gIH1cbn1cblxuLy9cbi8vIEF0dGFjaCBtYWluIE1hdGhKYXggc2NyaXB0IHRvIHRoZSBkb2N1bWVudFxuLy9cbmZ1bmN0aW9uIGF0dGFjaE1hdGhKYXhJbnRlcm5hbCgpIHtcbiAgLy8gTm90aWZ5IHVzZXIgTWF0aEpheCBpcyBsb2FkaW5nXG4gIGlmIChhdG9tLmluRGV2TW9kZSgpKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8oJ0xvYWRpbmcgbWF0aHMgcmVuZGVyaW5nIGVuZ2luZSBNYXRoSmF4JylcbiAgfVxuXG4gIC8vIEF0dGFjaCBNYXRoSmF4IHNjcmlwdFxuICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKVxuICBzY3JpcHQuc3JjID0gYCR7cmVxdWlyZS5yZXNvbHZlKCdNYXRoSmF4Jyl9P2RlbGF5U3RhcnR1cFVudGlsPWNvbmZpZ3VyZWRgXG4gIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCdcbiAgc2NyaXB0LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoKSA9PiB7XG4gICAgY29uZmlndXJlTWF0aEpheCgpXG4gIH0pXG4gIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0uYXBwZW5kQ2hpbGQoc2NyaXB0KVxuXG4gIHJldHVybiBzY3JpcHRcbn1cbiJdfQ==