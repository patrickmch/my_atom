"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const table_1 = require("./lib/table");
function scanDelims(state, start, delimLength) {
    let pos = start;
    let lastChar;
    let nextChar;
    let count;
    let canOpen;
    let canClose;
    let isLastWhiteSpace;
    let isLastPunctChar;
    let isNextWhiteSpace;
    let isNextPunctChar;
    let leftFlanking = true;
    let rightFlanking = true;
    const max = state.posMax;
    const isWhiteSpace = state.md.utils.isWhiteSpace;
    const isPunctChar = state.md.utils.isPunctChar;
    const isMdAsciiPunct = state.md.utils.isMdAsciiPunct;
    lastChar = start > 0 ? state.src.charCodeAt(start - 1) : 0x20;
    if (pos >= max) {
        canOpen = false;
    }
    pos += delimLength;
    count = pos - start;
    nextChar = pos < max ? state.src.charCodeAt(pos) : 0x20;
    isLastPunctChar =
        isMdAsciiPunct(lastChar) || isPunctChar(String.fromCharCode(lastChar));
    isNextPunctChar =
        isMdAsciiPunct(nextChar) || isPunctChar(String.fromCharCode(nextChar));
    isLastWhiteSpace = isWhiteSpace(lastChar);
    isNextWhiteSpace = isWhiteSpace(nextChar);
    if (isNextWhiteSpace) {
        leftFlanking = false;
    }
    else if (isNextPunctChar) {
        if (!(isLastWhiteSpace || isLastPunctChar)) {
            leftFlanking = false;
        }
    }
    if (isLastWhiteSpace) {
        rightFlanking = false;
    }
    else if (isLastPunctChar) {
        if (!(isNextWhiteSpace || isNextPunctChar)) {
            rightFlanking = false;
        }
    }
    canOpen = leftFlanking;
    canClose = rightFlanking;
    return {
        can_open: canOpen,
        can_close: canClose,
        delims: count,
    };
}
function makeMath_inline(delims) {
    return function math_inline(state, silent) {
        let startCount;
        let found;
        let res;
        let token;
        let closeDelim;
        const max = state.posMax;
        const start = state.pos;
        const foundDelims = delims.find(function (i) {
            const open = i[0];
            const openDelim = state.src.slice(start, start + open.length);
            return openDelim === open;
        });
        if (!foundDelims) {
            return false;
        }
        const open = foundDelims[0];
        const close = foundDelims[1];
        if (silent) {
            return false;
        }
        res = scanDelims(state, start, open.length);
        startCount = res.delims;
        if (!res.can_open) {
            state.pos += startCount;
            state.pending += state.src.slice(start, state.pos);
            return true;
        }
        state.pos = start + open.length;
        while (state.pos < max) {
            closeDelim = state.src.slice(state.pos, state.pos + close.length);
            if (closeDelim === close) {
                res = scanDelims(state, state.pos, close.length);
                if (res.can_close) {
                    found = true;
                    break;
                }
            }
            state.md.inline.skipToken(state);
        }
        if (!found) {
            state.pos = start;
            return false;
        }
        state.posMax = state.pos;
        state.pos = start + close.length;
        token = state.push('math_inline', 'math', 0);
        token.content = state.src.slice(state.pos, state.posMax);
        token.markup = open;
        state.pos = state.posMax + close.length;
        state.posMax = max;
        return true;
    };
}
function makeMath_block(delims) {
    return function math_block(state, startLine, endLine, silent) {
        let len;
        let nextLine;
        let token;
        let firstLine;
        let lastLine;
        let lastLinePos;
        let closeDelim;
        let haveEndMarker = false;
        let closeStartsAtNewline = false;
        let pos = state.bMarks[startLine] + state.tShift[startLine];
        let max = state.eMarks[startLine];
        const foundDelims = delims.find(function (i) {
            const open = i[0];
            const openDelim = state.src.slice(pos, pos + open.length);
            return openDelim === open;
        });
        if (!foundDelims) {
            return false;
        }
        const open = foundDelims[0];
        let close = foundDelims[1];
        if (close[0] === '\n') {
            closeStartsAtNewline = true;
            close = close.slice(1);
        }
        if (pos + open.length > max + 1) {
            return false;
        }
        pos += open.length;
        firstLine = state.src.slice(pos, max);
        if (silent) {
            return true;
        }
        if (firstLine.trim().slice(-close.length) === close) {
            firstLine = firstLine.trim().slice(0, -close.length);
            haveEndMarker = true;
        }
        nextLine = startLine;
        for (;;) {
            if (haveEndMarker) {
                break;
            }
            nextLine++;
            if (nextLine >= endLine) {
                break;
            }
            pos = state.bMarks[nextLine] + state.tShift[nextLine];
            max = state.eMarks[nextLine];
            if (pos < max && state.tShift[nextLine] < state.blkIndent) {
                break;
            }
            closeDelim = closeStartsAtNewline
                ? state.src.slice(pos, max).trim()
                : state.src
                    .slice(pos, max)
                    .trim()
                    .slice(-close.length);
            if (closeDelim !== close) {
                continue;
            }
            if (state.tShift[nextLine] - state.blkIndent >= 4) {
                continue;
            }
            lastLinePos = state.src.slice(0, max).lastIndexOf(close);
            lastLine = state.src.slice(pos, lastLinePos);
            pos += lastLine.length + close.length;
            pos = state.skipSpaces(pos);
            if (pos < max) {
                continue;
            }
            haveEndMarker = true;
        }
        len = state.tShift[startLine];
        state.line = nextLine + (haveEndMarker ? 1 : 0);
        token = state.push('math_block', 'math', 0);
        token.block = true;
        token.content =
            (firstLine && firstLine.trim() ? firstLine + '\n' : '') +
                state.getLines(startLine + 1, nextLine, len, true) +
                (lastLine && lastLine.trim() ? lastLine : '');
        token.map = [startLine, state.line];
        token.markup = open;
        return true;
    };
}
function makeMathRenderer(renderingOptions = {}) {
    return renderingOptions.display === 'block'
        ? function (tokens, idx) {
            return '<div class="math block">' + tokens[idx].content + '</div>\n';
        }
        : function (tokens, idx) {
            return '<span class="math inline">' + tokens[idx].content + '</span>';
        };
}
function math_plugin(md, options = {}) {
    const inlineDelim = options.inlineDelim || [['$$', '$$']];
    const blockDelim = options.blockDelim || [['$$$', '$$$']];
    const oInlineRenderer = options.inlineRenderer;
    const oBlockRenderer = options.blockRenderer;
    const inlineRenderer = oInlineRenderer
        ? function (tokens, idx) {
            return oInlineRenderer(tokens[idx].content);
        }
        : makeMathRenderer(options.renderingOptions);
    const blockRenderer = oBlockRenderer
        ? function (tokens, idx) {
            return oBlockRenderer(tokens[idx].content) + '\n';
        }
        : makeMathRenderer(Object.assign({ display: 'block' }, options.renderingOptions));
    const mathInline = makeMath_inline(inlineDelim);
    const mathBlock = makeMath_block(blockDelim);
    md.inline.ruler.before('escape', 'math_inline', mathInline);
    md.block.ruler.after('blockquote', 'math_block', mathBlock, {
        alt: ['paragraph', 'reference', 'blockquote', 'list'],
    });
    md.renderer.rules.math_inline = inlineRenderer;
    md.renderer.rules.math_block = blockRenderer;
    const tableBlock = table_1.makeTable({
        inlineDelim,
        blockDelim,
    });
    md.block.ruler.at('table', tableBlock, {
        alt: ['paragraph', 'reference'],
    });
}
exports.math_plugin = math_plugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWFya2Rvd24taXQtbWF0aC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUlBLHVDQUF1QztBQUV2QyxvQkFBb0IsS0FBVSxFQUFFLEtBQWEsRUFBRSxXQUFtQjtJQUNoRSxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUE7SUFDZixJQUFJLFFBQVEsQ0FBQTtJQUNaLElBQUksUUFBUSxDQUFBO0lBQ1osSUFBSSxLQUFLLENBQUE7SUFDVCxJQUFJLE9BQU8sQ0FBQTtJQUNYLElBQUksUUFBUSxDQUFBO0lBQ1osSUFBSSxnQkFBZ0IsQ0FBQTtJQUNwQixJQUFJLGVBQWUsQ0FBQTtJQUNuQixJQUFJLGdCQUFnQixDQUFBO0lBQ3BCLElBQUksZUFBZSxDQUFBO0lBQ25CLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQTtJQUN2QixJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUE7SUFDeEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQTtJQUN4QixNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUE7SUFDaEQsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFBO0lBQzlDLE1BQU0sY0FBYyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQTtJQUdwRCxRQUFRLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUE7SUFFN0QsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDZixPQUFPLEdBQUcsS0FBSyxDQUFBO0lBQ2pCLENBQUM7SUFFRCxHQUFHLElBQUks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QUFXLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxNQUFNLENBQUM7S0FDdEQsQ0FBQyxDQUFBO0lBQ0YsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsV0FBVyxHQUFHLGNBQWMsQ0FBQTtJQUM5QyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsYUFBYSxDQUFBO0lBRzVDLE1BQU0sVUFBVSxHQUFHLGlCQUFTLENBQUM7UUFDM0IsV0FBVztRQUNYLFVBQVU7S0FDWCxDQUFDLENBQUE7SUFDRixFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQVUsRUFBRTtRQUNyQyxHQUFHLEVBQUUsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDO0tBQ2hDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFyQ0Qsa0NBcUNDIiwic291cmNlc0NvbnRlbnQiOlsiLyogUHJvY2VzcyBpbmxpbmUgbWF0aCAqL1xuLy8gdHNsaW50OmRpc2FibGU6bm8tdW5zYWZlLWFueVxuXG5pbXBvcnQgKiBhcyBtZEl0IGZyb20gJ21hcmtkb3duLWl0J1xuaW1wb3J0IHsgbWFrZVRhYmxlIH0gZnJvbSAnLi9saWIvdGFibGUnXG5cbmZ1bmN0aW9uIHNjYW5EZWxpbXMoc3RhdGU6IGFueSwgc3RhcnQ6IG51bWJlciwgZGVsaW1MZW5ndGg6IG51bWJlcikge1xuICBsZXQgcG9zID0gc3RhcnRcbiAgbGV0IGxhc3RDaGFyXG4gIGxldCBuZXh0Q2hhclxuICBsZXQgY291bnRcbiAgbGV0IGNhbk9wZW5cbiAgbGV0IGNhbkNsb3NlXG4gIGxldCBpc0xhc3RXaGl0ZVNwYWNlXG4gIGxldCBpc0xhc3RQdW5jdENoYXJcbiAgbGV0IGlzTmV4dFdoaXRlU3BhY2VcbiAgbGV0IGlzTmV4dFB1bmN0Q2hhclxuICBsZXQgbGVmdEZsYW5raW5nID0gdHJ1ZVxuICBsZXQgcmlnaHRGbGFua2luZyA9IHRydWVcbiAgY29uc3QgbWF4ID0gc3RhdGUucG9zTWF4XG4gIGNvbnN0IGlzV2hpdGVTcGFjZSA9IHN0YXRlLm1kLnV0aWxzLmlzV2hpdGVTcGFjZVxuICBjb25zdCBpc1B1bmN0Q2hhciA9IHN0YXRlLm1kLnV0aWxzLmlzUHVuY3RDaGFyXG4gIGNvbnN0IGlzTWRBc2NpaVB1bmN0ID0gc3RhdGUubWQudXRpbHMuaXNNZEFzY2lpUHVuY3RcblxuICAvLyB0cmVhdCBiZWdpbm5pbmcgb2YgdGhlIGxpbmUgYXMgYSB3aGl0ZXNwYWNlXG4gIGxhc3RDaGFyID0gc3RhcnQgPiAwID8gc3RhdGUuc3JjLmNoYXJDb2RlQXQoc3RhcnQgLSAxKSA6IDB4MjBcblxuICBpZiAocG9zID49IG1heCkge1xuICAgIGNhbk9wZW4gPSBmYWxzZVxuICB9XG5cbiAgcG9zICs9IGRlbGltTGVuZ3RoXG5cbiAgY291bnQgPSBwb3MgLSBzdGFydFxuXG4gIC8vIHRyZWF0IGVuZCBvZiB0aGUgbGluZSBhcyBhIHdoaXRlc3BhY2VcbiAgbmV4dENoYXIgPSBwb3MgPCBtYXggPyBzdGF0ZS5zcmMuY2hhckNvZGVBdChwb3MpIDogMHgyMFxuXG4gIGlzTGFzdFB1bmN0Q2hhciA9XG4gICAgaXNNZEFzY2lpUHVuY3QobGFzdENoYXIpIHx8IGlzUHVuY3RDaGFyKFN0cmluZy5mcm9tQ2hhckNvZGUobGFzdENoYXIpKVxuICBpc05leHRQdW5jdENoYXIgPVxuICAgIGlzTWRBc2NpaVB1bmN0KG5leHRDaGFyKSB8fCBpc1B1bmN0Q2hhcihTdHJpbmcuZnJvbUNoYXJDb2RlKG5leHRDaGFyKSlcblxuICBpc0xhc3RXaGl0ZVNwYWNlID0gaXNXaGl0ZVNwYWNlKGxhc3RDaGFyKVxuICBpc05leHRXaGl0ZVNwYWNlID0gaXNXaGl0ZVNwYWNlKG5leHRDaGFyKVxuXG4gIGlmIChpc05leHRXaGl0ZVNwYWNlKSB7XG4gICAgbGVmdEZsYW5raW5nID0gZmFsc2VcbiAgfSBlbHNlIGlmIChpc05leHRQdW5jdENoYXIpIHtcbiAgICBpZiAoIShpc0xhc3RXaGl0ZVNwYWNlIHx8IGlzTGFzdFB1bmN0Q2hhcikpIHtcbiAgICAgIGxlZnRGbGFua2luZyA9IGZhbHNlXG4gICAgfVxuICB9XG5cbiAgaWYgKGlzTGFzdFdoaXRlU3BhY2UpIHtcbiAgICByaWdodEZsYW5raW5nID0gZmFsc2VcbiAgfSBlbHNlIGlmIChpc0xhc3RQdW5jdENoYXIpIHtcbiAgICBpZiAoIShpc05leHRXaGl0ZVNwYWNlIHx8IGlzTmV4dFB1bmN0Q2hhcikpIHtcbiAgICAgIHJpZ2h0RmxhbmtpbmcgPSBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIGNhbk9wZW4gPSBsZWZ0RmxhbmtpbmdcbiAgY2FuQ2xvc2UgPSByaWdodEZsYW5raW5nXG5cbiAgcmV0dXJuIHtcbiAgICBjYW5fb3BlbjogY2FuT3BlbixcbiAgICBjYW5fY2xvc2U6IGNhbkNsb3NlLFxuICAgIGRlbGltczogY291bnQsXG4gIH1cbn1cblxuZnVuY3Rpb24gbWFrZU1hdGhfaW5saW5lKGRlbGltczogW1tzdHJpbmcsIHN0cmluZ11dKSB7XG4gIHJldHVybiBmdW5jdGlvbiBtYXRoX2lubGluZShzdGF0ZTogYW55LCBzaWxlbnQ6IGJvb2xlYW4pIHtcbiAgICBsZXQgc3RhcnRDb3VudFxuICAgIGxldCBmb3VuZFxuICAgIGxldCByZXNcbiAgICBsZXQgdG9rZW5cbiAgICBsZXQgY2xvc2VEZWxpbVxuICAgIGNvbnN0IG1heCA9IHN0YXRlLnBvc01heCBhcyBudW1iZXJcbiAgICBjb25zdCBzdGFydCA9IHN0YXRlLnBvcyBhcyBudW1iZXJcbiAgICBjb25zdCBmb3VuZERlbGltcyA9IGRlbGltcy5maW5kKGZ1bmN0aW9uKGkpIHtcbiAgICAgIGNvbnN0IG9wZW4gPSBpWzBdXG4gICAgICBjb25zdCBvcGVuRGVsaW0gPSBzdGF0ZS5zcmMuc2xpY2Uoc3RhcnQsIHN0YXJ0ICsgb3Blbi5sZW5ndGgpIGFzIHN0cmluZ1xuICAgICAgcmV0dXJuIG9wZW5EZWxpbSA9PT0gb3BlblxuICAgIH0pXG4gICAgaWYgKCFmb3VuZERlbGltcykge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIGNvbnN0IG9wZW4gPSBmb3VuZERlbGltc1swXVxuICAgIGNvbnN0IGNsb3NlID0gZm91bmREZWxpbXNbMV1cbiAgICBpZiAoc2lsZW50KSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9IC8vIERvbuKAmXQgcnVuIGFueSBwYWlycyBpbiB2YWxpZGF0aW9uIG1vZGVcblxuICAgIHJlcyA9IHNjYW5EZWxpbXMoc3RhdGUsIHN0YXJ0LCBvcGVuLmxlbmd0aClcbiAgICBzdGFydENvdW50ID0gcmVzLmRlbGltc1xuXG4gICAgaWYgKCFyZXMuY2FuX29wZW4pIHtcbiAgICAgIHN0YXRlLnBvcyArPSBzdGFydENvdW50XG4gICAgICAvLyBFYXJsaWVyIHdlIGNoZWNrZWQgIXNpbGVudCwgYnV0IHRoaXMgaW1wbGVtZW50YXRpb24gZG9lcyBub3QgbmVlZCBpdFxuICAgICAgc3RhdGUucGVuZGluZyArPSBzdGF0ZS5zcmMuc2xpY2Uoc3RhcnQsIHN0YXRlLnBvcylcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgc3RhdGUucG9zID0gc3RhcnQgKyBvcGVuLmxlbmd0aFxuXG4gICAgd2hpbGUgKHN0YXRlLnBvcyA8IG1heCkge1xuICAgICAgY2xvc2VEZWxpbSA9IHN0YXRlLnNyYy5zbGljZShzdGF0ZS5wb3MsIHN0YXRlLnBvcyArIGNsb3NlLmxlbmd0aClcbiAgICAgIGlmIChjbG9zZURlbGltID09PSBjbG9zZSkge1xuICAgICAgICByZXMgPSBzY2FuRGVsaW1zKHN0YXRlLCBzdGF0ZS5wb3MsIGNsb3NlLmxlbmd0aClcbiAgICAgICAgaWYgKHJlcy5jYW5fY2xvc2UpIHtcbiAgICAgICAgICBmb3VuZCA9IHRydWVcbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHN0YXRlLm1kLmlubGluZS5za2lwVG9rZW4oc3RhdGUpXG4gICAgfVxuXG4gICAgaWYgKCFmb3VuZCkge1xuICAgICAgLy8gUGFyc2VyIGZhaWxlZCB0byBmaW5kIGVuZGluZyB0YWcsIHNvIGl0IGlzIG5vdCBhIHZhbGlkIG1hdGhcbiAgICAgIHN0YXRlLnBvcyA9IHN0YXJ0XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICAvLyBGb3VuZCFcbiAgICBzdGF0ZS5wb3NNYXggPSBzdGF0ZS5wb3NcbiAgICBzdGF0ZS5wb3MgPSBzdGFydCArIGNsb3NlLmxlbmd0aFxuXG4gICAgLy8gRWFybGllciB3ZSBjaGVja2VkICFzaWxlbnQsIGJ1dCB0aGlzIGltcGxlbWVudGF0aW9uIGRvZXMgbm90IG5lZWQgaXRcbiAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ21hdGhfaW5saW5lJywgJ21hdGgnLCAwKVxuICAgIHRva2VuLmNvbnRlbnQgPSBzdGF0ZS5zcmMuc2xpY2Uoc3RhdGUucG9zLCBzdGF0ZS5wb3NNYXgpXG4gICAgdG9rZW4ubWFya3VwID0gb3BlblxuXG4gICAgc3RhdGUucG9zID0gc3RhdGUucG9zTWF4ICsgY2xvc2UubGVuZ3RoXG4gICAgc3RhdGUucG9zTWF4ID0gbWF4XG5cbiAgICByZXR1cm4gdHJ1ZVxuICB9XG59XG5cbmZ1bmN0aW9uIG1ha2VNYXRoX2Jsb2NrKGRlbGltczogW1tzdHJpbmcsIHN0cmluZ11dKSB7XG4gIHJldHVybiBmdW5jdGlvbiBtYXRoX2Jsb2NrKFxuICAgIHN0YXRlOiBhbnksXG4gICAgc3RhcnRMaW5lOiBudW1iZXIsXG4gICAgZW5kTGluZTogbnVtYmVyLFxuICAgIHNpbGVudDogYm9vbGVhbixcbiAgKSB7XG4gICAgbGV0IGxlblxuICAgIGxldCBuZXh0TGluZVxuICAgIGxldCB0b2tlblxuICAgIGxldCBmaXJzdExpbmU6IHN0cmluZ1xuICAgIGxldCBsYXN0TGluZVxuICAgIGxldCBsYXN0TGluZVBvc1xuICAgIGxldCBjbG9zZURlbGltXG4gICAgbGV0IGhhdmVFbmRNYXJrZXIgPSBmYWxzZVxuICAgIGxldCBjbG9zZVN0YXJ0c0F0TmV3bGluZSA9IGZhbHNlXG4gICAgbGV0IHBvczogbnVtYmVyID0gc3RhdGUuYk1hcmtzW3N0YXJ0TGluZV0gKyBzdGF0ZS50U2hpZnRbc3RhcnRMaW5lXVxuICAgIGxldCBtYXg6IG51bWJlciA9IHN0YXRlLmVNYXJrc1tzdGFydExpbmVdXG5cbiAgICBjb25zdCBmb3VuZERlbGltcyA9IGRlbGltcy5maW5kKGZ1bmN0aW9uKGkpIHtcbiAgICAgIGNvbnN0IG9wZW4gPSBpWzBdXG4gICAgICBjb25zdCBvcGVuRGVsaW0gPSBzdGF0ZS5zcmMuc2xpY2UocG9zLCBwb3MgKyBvcGVuLmxlbmd0aClcbiAgICAgIHJldHVybiBvcGVuRGVsaW0gPT09IG9wZW5cbiAgICB9KVxuICAgIGlmICghZm91bmREZWxpbXMpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICBjb25zdCBvcGVuID0gZm91bmREZWxpbXNbMF1cbiAgICBsZXQgY2xvc2UgPSBmb3VuZERlbGltc1sxXVxuXG4gICAgaWYgKGNsb3NlWzBdID09PSAnXFxuJykge1xuICAgICAgY2xvc2VTdGFydHNBdE5ld2xpbmUgPSB0cnVlXG4gICAgICBjbG9zZSA9IGNsb3NlLnNsaWNlKDEpXG4gICAgfVxuXG4gICAgaWYgKHBvcyArIG9wZW4ubGVuZ3RoID4gbWF4ICsgMSkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuXG4gICAgcG9zICs9IG9wZW4ubGVuZ3RoXG4gICAgZmlyc3RMaW5lID0gc3RhdGUuc3JjLnNsaWNlKHBvcywgbWF4KVxuXG4gICAgLy8gU2luY2Ugc3RhcnQgaXMgZm91bmQsIHdlIGNhbiByZXBvcnQgc3VjY2VzcyBoZXJlIGluIHZhbGlkYXRpb24gbW9kZVxuICAgIGlmIChzaWxlbnQpIHtcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgaWYgKGZpcnN0TGluZS50cmltKCkuc2xpY2UoLWNsb3NlLmxlbmd0aCkgPT09IGNsb3NlKSB7XG4gICAgICAvLyBTaW5nbGUgbGluZSBleHByZXNzaW9uXG4gICAgICBmaXJzdExpbmUgPSBmaXJzdExpbmUudHJpbSgpLnNsaWNlKDAsIC1jbG9zZS5sZW5ndGgpXG4gICAgICBoYXZlRW5kTWFya2VyID0gdHJ1ZVxuICAgIH1cblxuICAgIC8vIHNlYXJjaCBlbmQgb2YgYmxvY2tcbiAgICBuZXh0TGluZSA9IHN0YXJ0TGluZVxuXG4gICAgZm9yICg7Oykge1xuICAgICAgaWYgKGhhdmVFbmRNYXJrZXIpIHtcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cblxuICAgICAgbmV4dExpbmUrK1xuXG4gICAgICBpZiAobmV4dExpbmUgPj0gZW5kTGluZSkge1xuICAgICAgICAvLyB1bmNsb3NlZCBibG9jayBzaG91bGQgYmUgYXV0b2Nsb3NlZCBieSBlbmQgb2YgZG9jdW1lbnQuXG4gICAgICAgIC8vIGFsc28gYmxvY2sgc2VlbXMgdG8gYmUgYXV0b2Nsb3NlZCBieSBlbmQgb2YgcGFyZW50XG4gICAgICAgIGJyZWFrXG4gICAgICB9XG5cbiAgICAgIHBvcyA9IHN0YXRlLmJNYXJrc1tuZXh0TGluZV0gKyBzdGF0ZS50U2hpZnRbbmV4dExpbmVdXG4gICAgICBtYXggPSBzdGF0ZS5lTWFya3NbbmV4dExpbmVdXG5cbiAgICAgIGlmIChwb3MgPCBtYXggJiYgc3RhdGUudFNoaWZ0W25leHRMaW5lXSA8IHN0YXRlLmJsa0luZGVudCkge1xuICAgICAgICAvLyBub24tZW1wdHkgbGluZSB3aXRoIG5lZ2F0aXZlIGluZGVudCBzaG91bGQgc3RvcCB0aGUgbGlzdDpcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cblxuICAgICAgY2xvc2VEZWxpbSA9IGNsb3NlU3RhcnRzQXROZXdsaW5lXG4gICAgICAgID8gc3RhdGUuc3JjLnNsaWNlKHBvcywgbWF4KS50cmltKClcbiAgICAgICAgOiBzdGF0ZS5zcmNcbiAgICAgICAgICAgIC5zbGljZShwb3MsIG1heClcbiAgICAgICAgICAgIC50cmltKClcbiAgICAgICAgICAgIC5zbGljZSgtY2xvc2UubGVuZ3RoKVxuXG4gICAgICBpZiAoY2xvc2VEZWxpbSAhPT0gY2xvc2UpIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cblxuICAgICAgaWYgKHN0YXRlLnRTaGlmdFtuZXh0TGluZV0gLSBzdGF0ZS5ibGtJbmRlbnQgPj0gNCkge1xuICAgICAgICAvLyBjbG9zaW5nIGJsb2NrIG1hdGggc2hvdWxkIGJlIGluZGVudGVkIGxlc3MgdGhlbiA0IHNwYWNlc1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICBsYXN0TGluZVBvcyA9IHN0YXRlLnNyYy5zbGljZSgwLCBtYXgpLmxhc3RJbmRleE9mKGNsb3NlKVxuICAgICAgbGFzdExpbmUgPSBzdGF0ZS5zcmMuc2xpY2UocG9zLCBsYXN0TGluZVBvcylcblxuICAgICAgcG9zICs9IGxhc3RMaW5lLmxlbmd0aCArIGNsb3NlLmxlbmd0aFxuXG4gICAgICAvLyBtYWtlIHN1cmUgdGFpbCBoYXMgc3BhY2VzIG9ubHlcbiAgICAgIHBvcyA9IHN0YXRlLnNraXBTcGFjZXMocG9zKVxuXG4gICAgICBpZiAocG9zIDwgbWF4KSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG5cbiAgICAgIC8vIGZvdW5kIVxuICAgICAgaGF2ZUVuZE1hcmtlciA9IHRydWVcbiAgICB9XG5cbiAgICAvLyBJZiBtYXRoIGJsb2NrIGhhcyBoZWFkaW5nIHNwYWNlcywgdGhleSBzaG91bGQgYmUgcmVtb3ZlZCBmcm9tIGl0cyBpbm5lciBibG9ja1xuICAgIGxlbiA9IHN0YXRlLnRTaGlmdFtzdGFydExpbmVdXG5cbiAgICBzdGF0ZS5saW5lID0gbmV4dExpbmUgKyAoaGF2ZUVuZE1hcmtlciA/IDEgOiAwKVxuXG4gICAgdG9rZW4gPSBzdGF0ZS5wdXNoKCdtYXRoX2Jsb2NrJywgJ21hdGgnLCAwKVxuICAgIHRva2VuLmJsb2NrID0gdHJ1ZVxuICAgIHRva2VuLmNvbnRlbnQgPVxuICAgICAgKGZpcnN0TGluZSAmJiBmaXJzdExpbmUudHJpbSgpID8gZmlyc3RMaW5lICsgJ1xcbicgOiAnJykgK1xuICAgICAgc3RhdGUuZ2V0TGluZXMoc3RhcnRMaW5lICsgMSwgbmV4dExpbmUsIGxlbiwgdHJ1ZSkgK1xuICAgICAgKGxhc3RMaW5lICYmIGxhc3RMaW5lLnRyaW0oKSA/IGxhc3RMaW5lIDogJycpXG4gICAgdG9rZW4ubWFwID0gW3N0YXJ0TGluZSwgc3RhdGUubGluZV1cbiAgICB0b2tlbi5tYXJrdXAgPSBvcGVuXG5cbiAgICByZXR1cm4gdHJ1ZVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVuZGVyaW5nT3B0aW9ucyB7XG4gIGRpc3BsYXk/OiAnYmxvY2snXG59XG5cbmZ1bmN0aW9uIG1ha2VNYXRoUmVuZGVyZXIocmVuZGVyaW5nT3B0aW9uczogUmVuZGVyaW5nT3B0aW9ucyA9IHt9KSB7XG4gIHJldHVybiByZW5kZXJpbmdPcHRpb25zLmRpc3BsYXkgPT09ICdibG9jaydcbiAgICA/IGZ1bmN0aW9uKHRva2VuczogbWRJdC5Ub2tlbltdLCBpZHg6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gJzxkaXYgY2xhc3M9XCJtYXRoIGJsb2NrXCI+JyArIHRva2Vuc1tpZHhdLmNvbnRlbnQgKyAnPC9kaXY+XFxuJ1xuICAgICAgfVxuICAgIDogZnVuY3Rpb24odG9rZW5zOiBtZEl0LlRva2VuW10sIGlkeDogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCJtYXRoIGlubGluZVwiPicgKyB0b2tlbnNbaWR4XS5jb250ZW50ICsgJzwvc3Bhbj4nXG4gICAgICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGx1Z2luT3B0aW9ucyB7XG4gIGlubGluZURlbGltPzogW1tzdHJpbmcsIHN0cmluZ11dXG4gIGJsb2NrRGVsaW0/OiBbW3N0cmluZywgc3RyaW5nXV1cbiAgaW5saW5lUmVuZGVyZXI/OiAoZGF0YTogc3RyaW5nKSA9PiBzdHJpbmdcbiAgYmxvY2tSZW5kZXJlcj86IChkYXRhOiBzdHJpbmcpID0+IHN0cmluZ1xuICByZW5kZXJpbmdPcHRpb25zPzogUmVuZGVyaW5nT3B0aW9uc1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWF0aF9wbHVnaW4obWQ6IG1kSXQuTWFya2Rvd25JdCwgb3B0aW9uczogUGx1Z2luT3B0aW9ucyA9IHt9KSB7XG4gIC8vIERlZmF1bHQgb3B0aW9uc1xuICBjb25zdCBpbmxpbmVEZWxpbSA9IG9wdGlvbnMuaW5saW5lRGVsaW0gfHwgW1snJCQnLCAnJCQnXV1cbiAgY29uc3QgYmxvY2tEZWxpbSA9IG9wdGlvbnMuYmxvY2tEZWxpbSB8fCBbWyckJCQnLCAnJCQkJ11dXG4gIGNvbnN0IG9JbmxpbmVSZW5kZXJlciA9IG9wdGlvbnMuaW5saW5lUmVuZGVyZXJcbiAgY29uc3Qgb0Jsb2NrUmVuZGVyZXIgPSBvcHRpb25zLmJsb2NrUmVuZGVyZXJcbiAgY29uc3QgaW5saW5lUmVuZGVyZXIgPSBvSW5saW5lUmVuZGVyZXJcbiAgICA/IGZ1bmN0aW9uKHRva2VuczogbWRJdC5Ub2tlbltdLCBpZHg6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gb0lubGluZVJlbmRlcmVyKHRva2Vuc1tpZHhdLmNvbnRlbnQpXG4gICAgICB9XG4gICAgOiBtYWtlTWF0aFJlbmRlcmVyKG9wdGlvbnMucmVuZGVyaW5nT3B0aW9ucylcbiAgY29uc3QgYmxvY2tSZW5kZXJlciA9IG9CbG9ja1JlbmRlcmVyXG4gICAgPyBmdW5jdGlvbih0b2tlbnM6IG1kSXQuVG9rZW5bXSwgaWR4OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIG9CbG9ja1JlbmRlcmVyKHRva2Vuc1tpZHhdLmNvbnRlbnQpICsgJ1xcbidcbiAgICAgIH1cbiAgICA6IG1ha2VNYXRoUmVuZGVyZXIoXG4gICAgICAgIE9iamVjdC5hc3NpZ24oeyBkaXNwbGF5OiAnYmxvY2snIH0sIG9wdGlvbnMucmVuZGVyaW5nT3B0aW9ucyksXG4gICAgICApXG5cbiAgY29uc3QgbWF0aElubGluZSA9IChtYWtlTWF0aF9pbmxpbmUoaW5saW5lRGVsaW0pIGFzIGFueSkgYXMgbWRJdC5SdWxlXG4gIGNvbnN0IG1hdGhCbG9jayA9IChtYWtlTWF0aF9ibG9jayhibG9ja0RlbGltKSBhcyBhbnkpIGFzIG1kSXQuUnVsZVxuXG4gIG1kLmlubGluZS5ydWxlci5iZWZvcmUoJ2VzY2FwZScsICdtYXRoX2lubGluZScsIG1hdGhJbmxpbmUpXG4gIG1kLmJsb2NrLnJ1bGVyLmFmdGVyKCdibG9ja3F1b3RlJywgJ21hdGhfYmxvY2snLCBtYXRoQmxvY2ssIHtcbiAgICBhbHQ6IFsncGFyYWdyYXBoJywgJ3JlZmVyZW5jZScsICdibG9ja3F1b3RlJywgJ2xpc3QnXSxcbiAgfSlcbiAgbWQucmVuZGVyZXIucnVsZXMubWF0aF9pbmxpbmUgPSBpbmxpbmVSZW5kZXJlclxuICBtZC5yZW5kZXJlci5ydWxlcy5tYXRoX2Jsb2NrID0gYmxvY2tSZW5kZXJlclxuXG4gIC8vIFJlcGxhY2UgZXhpc3RpbmcgdGFibGUgcGFyc2VyIHdpdGggcGFyc2VyIHRoYXQgcmVzcGVjdHMgbmV3IGlubGluZSBkZWxpbXNcbiAgY29uc3QgdGFibGVCbG9jayA9IG1ha2VUYWJsZSh7XG4gICAgaW5saW5lRGVsaW0sXG4gICAgYmxvY2tEZWxpbSxcbiAgfSlcbiAgbWQuYmxvY2sucnVsZXIuYXQoJ3RhYmxlJywgdGFibGVCbG9jaywge1xuICAgIGFsdDogWydwYXJhZ3JhcGgnLCAncmVmZXJlbmNlJ10sXG4gIH0pXG59XG4iXX0=